<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CR7 Redirect</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Ganti sesuai project
    const supabaseUrl = 'https://pjawwektzazcxakgopou.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBqYXd3ZWt0emF6Y3hha2dvcG91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNjQ5MTUsImV4cCI6MjA3Mzg0MDkxNX0.dNEB80t7LcTsvAtHHqgIeJfxcwmmZNsWxPTIAlrj11c';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    document.addEventListener("DOMContentLoaded", checkAuthState);

    async function checkAuthState() {
      try {
        // cek session
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          window.location.href = 'login.html';
          return;
        }

        // ambil user
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = 'login.html';
          return;
        }

        // ambil role dari tabel users
        const { data: userData, error } = await supabase
          .from('users')
          .select('role')
          .eq('id', user.id)
          .single();

        if (error || !userData) {
          console.error("Error ambil role:", error);
          window.location.href = 'login.html';
          return;
        }

        const role = userData.role;

        // redirect sesuai role
        switch (role) {
          case 'teknisi':
            window.location.href = 'teknisi.html';
            break;
          case 'sparepart':
            window.location.href = 'sparepart.html';
            break;
          case 'sa':
            window.location.href = 'sa.html';
            break;
          case 'mra':
            window.location.href = 'mra.html';
            break;
          default:
            window.location.href = 'login.html';
        }

      } catch (err) {
        console.error('Error checking auth state:', err);
        window.location.href = 'login.html';
      }
    }
  </script>
</head>
<body>
  <p>Sedang mengarahkan...</p>
</body>
</html>
