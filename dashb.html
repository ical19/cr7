<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Debug Estimasi</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Debug Estimasi</h1>
  <div id="estimasi-container">Loading...</div>

  <script>
    // ðŸ”‘ Supabase Credentials
    const supabaseUrl = 'https://pjawwektzazcxakgopou.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBqYXd3ZWt0emF6Y3hha2dvcG91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNjQ5MTUsImV4cCI6MjA3Mzg0MDkxNX0.dNEB80t7LcTsvAtHHqgIeJfxcwmmZNsWxPTIAlrj11c';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // ðŸ”Ž Ganti dengan ID estimasi yang mau ditest
    const currentEstimasiId = "b4049fbe-d22b-4a45-890e-ec771c200688";

    async function debugEstimasiHtml() {
      try {
        const { data, error } = await supabase
          .from('estimasi')
          .select('*')
          .eq('id', currentEstimasiId)
          .single();

        if (error) throw error;

        console.log("Raw data dari Supabase:", data);

        // ðŸ”Ž Parsing sparepart_data
        let sparepartData = [];
        if (data.sparepart_dat) {
          if (Array.isArray(data.sparepart_dat)) {
            sparepartData = data.sparepart_dat;
          } else if (typeof data.sparepart_dat === 'string') {
            try {
              const parsed = JSON.parse(data.sparepart_dat);
              sparepartData = Array.isArray(parsed)
                ? parsed
                : (parsed && typeof parsed === 'object')
                  ? Object.values(parsed)
                  : [parsed];
            } catch {
              sparepartData = [data.sparepart_dat];
            }
          } else if (typeof data.sparepart_dat === 'object') {
            sparepartData = Object.values(data.sparepart_dat);
          }
        }

        // ðŸ”Ž Parsing foto_url
        let fotoUrls = [];
        if (data.foto_url) {
          if (Array.isArray(data.foto_url)) {
            fotoUrls = data.foto_url;
          } else if (typeof data.foto_url === 'string') {
            try {
              const parsed = JSON.parse(data.foto_url);
              fotoUrls = Array.isArray(parsed) ? parsed : [data.foto_url];
            } catch {
              fotoUrls = [data.foto_url];
            }
          }
        }

        // ðŸ”Ž Bangun HTML
        const html = `
          <div style="font-family: Arial, sans-serif; padding: 20px;">
            <h2>Estimasi Perbaikan Kendaraan</h2>
            <p><strong>Nomor Polisi:</strong> ${data.nopol}</p>
            <p><strong>Jenis Mobil:</strong> ${data.jenis_mobil}</p>
            <p><strong>Nomor Rangka:</strong> ${data.nomor_rangk || '-'}</p>
            <p><strong>Telepon Customer:</strong> ${data.telepon_custc || '-'}</p>
            <p><strong>Service Advisor:</strong> ${data.service_advisc || '-'}</p>
            <p><strong>Tanggal Estimasi:</strong> ${new Date(data.created_at).toLocaleDateString('id-ID')}</p>
            <hr>
            <h3>Komponen</h3>
            <ul>
              ${Array.isArray(data.komponen)
                ? data.komponen.map(k => `<li>${k}</li>`).join('')
                : `<li>${data.komponen}</li>`}
            </ul>
            <h3>Keterangan</h3>
            <p>${data.keterangan || '-'}</p>
            <h3>Sparepart</h3>
            ${sparepartData.length > 0 ? `
              <table border="1" cellspacing="0" cellpadding="4">
                <tr>
                  <th>Kode</th><th>Nama</th><th>Jumlah</th><th>Ketersediaan</th><th>Harga</th><th>Subtotal</th>
                </tr>
                ${sparepartData.map(item => {
                  const it = (typeof item === 'string') ? { name: item } : (item || {});
                  return `
                    <tr>
                      <td>${it.number || '-'}</td>
                      <td>${it.name || '-'}</td>
                      <td>${it.quantity || '-'}</td>
                      <td>${it.availability || '-'}</td>
                      <td>${it.price || '-'}</td>
                      <td>${it.subtotal || '-'}</td>
                    </tr>
                  `;
                }).join('')}
              </table>
            ` : '<p>Tidak ada sparepart</p>'}
            <h3>Foto</h3>
            ${fotoUrls.map(url => `<img src="${url}" style="max-width:150px; margin:5px;">`).join('')}
          </div>
        `;

        document.getElementById("estimasi-container").innerHTML = html;

      } catch (err) {
        console.error("Error debugEstimasiHtml:", err);
        document.getElementById("estimasi-container").innerHTML =
          `<pre>${err.message}</pre>`;
      }
    }

    debugEstimasiHtml();
  </script>
</body>
</html>
