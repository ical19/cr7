<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimasi Perbaikan Kendaraan - Tunas Toyota</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #e60000;
            --primary-dark: #b30000;
            --secondary: #003b71;
            --light-bg: #f8f9fa;
            --dark-text: #333333;
            --light-text: #6c757d;
            --border: #dee2e6;
            --success: #28a745;
            --warning: #ffc107;
            --info: #17a2b8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f5f5f5;
            color: var(--dark-text);
            line-height: 1.6;
            padding: 20px;
        }
        
        .official-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 10px;
            border-top: 5px solid var(--primary);
        }
        
        .official-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        
        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .logo {
            height: 70px;
            margin-right: 15px;
        }
        
        .official-header h2 {
            color: var(--primary);
            margin-bottom: 5px;
            font-size: 28px;
            font-weight: 700;
        }
        
        .official-header p {
            margin: 3px 0;
            font-size: 14px;
            color: var(--light-text);
        }
        
        .official-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .info-card {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
        }
        
        .info-card h3 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        .info-item {
            margin-bottom: 10px;
            display: flex;
        }
        
        .info-label {
            font-weight: 600;
            color: var(--dark-text);
            min-width: 160px;
        }
        
        .info-value {
            color: var(--dark-text);
            flex: 1;
        }
        
        .official-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        
        .official-table th {
            background-color: var(--secondary);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .official-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .official-table tr:last-child td {
            border-bottom: none;
        }
        
        .official-table tr:nth-child(even) {
            background-color: var(--light-bg);
        }
        
        .total-row {
            font-weight: bold;
            background-color: rgba(0, 59, 113, 0.1) !important;
            color: var(--secondary);
        }
        
        .foto-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .foto-item {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .foto-item:hover {
            transform: translateY(-3px);
        }
        
        .foto-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }
        
        .contact-box {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border-left: 4px solid var(--primary);
        }
        
        .official-footer {
            text-align: center;
            font-size: 14px;
            color: var(--light-text);
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-pending {
            background-color: rgba(255, 193, 7, 0.2);
            color: var(--warning);
        }
        
        .status-progress {
            background-color: rgba(23, 162, 184, 0.2);
            color: var(--info);
        }
        
        .status-completed {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success);
        }
        
        .wa-link {
            color: #25D366;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .wa-link:hover {
            text-decoration: underline;
        }
        
        .section-title {
            background: linear-gradient(to right, transparent, rgba(0, 59, 113, 0.1), transparent);
            padding: 12px 15px;
            margin: 25px 0 15px 0;
            font-weight: 600;
            font-size: 18px;
            color: var(--secondary);
            border-left: 4px solid var(--secondary);
        }
        
        ul {
            list-style-type: none;
            padding-left: 5px;
        }
        
        ul li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }
        
        ul li::before {
            content: '•';
            position: absolute;
            left: 0;
            color: var(--primary);
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--light-text);
        }
        
        .loading i {
            font-size: 40px;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .error-message {
            background-color: #ffe6e6;
            color: #cc0000;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .official-grid {
                grid-template-columns: 1fr;
            }
            
            .official-container {
                padding: 15px;
            }
            
            .info-item {
                flex-direction: column;
            }
            
            .info-label {
                min-width: auto;
                margin-bottom: 5px;
            }
            
            .logo-container {
                flex-direction: column;
                text-align: center;
            }
            
            .logo {
                margin-right: 0;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="official-container">
        <div id="pdf-content">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Memuat data estimasi...</p>
            </div>
        </div>
    </div>

    <script>
        // Inisialisasi Supabase
        const supabaseUrl = 'https://pjawwektzazcxakgopou.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBqYXd3ZWt0emF6Y3hha2dvcG91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNjQ5MTUsImV4cCI6MjA3Mzg0MDkxNX0.dNEB80t7LcTsvAtHHqgIeJfxcwmmZNsWxPTIAlrj11c';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Fungsi untuk mendapatkan parameter URL
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }
        
        // Fungsi untuk mendapatkan teks status
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Menunggu',
                'progress': 'Dalam Proses',
                'completed': 'Selesai'
            };
            return statusMap[status] || status;
        }
        
        // Fungsi untuk mendapatkan class status
        function getStatusClass(status) {
            const statusClassMap = {
                'pending': 'status-pending',
                'progress': 'status-progress',
                'completed': 'status-completed'
            };
            return statusClassMap[status] || '';
        }

        // Format angka ke format Rupiah
        function formatRupiah(angka) {
            if (!angka) return 'Rp 0';
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(angka);
        }

        // Fungsi untuk memproses data dari Supabase
        function generatePDFContent(data) {
            // Parse data JSON jika diperlukan
            const komponen = typeof data.komponen === 'string' ? 
                JSON.parse(data.komponen.replace(/\\"/g, '"')) : data.komponen;
                
            const sparepartData = typeof data.sparepart_data === 'string' ? 
                JSON.parse(data.sparepart_data) : data.sparepart_data;
                
            const fotoUrls = typeof data.foto_url === 'string' ? 
                JSON.parse(data.foto_url) : data.foto_url;
            
            return `
            <div class="official-header">
                <div class="logo-container">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9d/Toyota.svg/1200px-Toyota.svg.png" alt="Toyota Logo" class="logo">
                    <div>
                        <h2>TUNAS TOYOTA BATUTULIS</h2>
                        <p>Jl. Batutulis No. 42, RT.7/RW.2 Jakarta Pusat</p>
                        <p>Telp: (021) 3454465 | Email: info@tunastoyota-batutulis.com</p>
                    </div>
                </div>
            </div>
            
            <h3 class="section-title">ESTIMASI PERBAIKAN KENDARAAN</h3>
            
            <div class="official-grid">
                <div class="info-card">
                    <h3>INFORMASI KENDARAAN</h3>
                    <div class="info-item">
                        <span class="info-label">Nomor Polisi:</span>
                        <span class="info-value">${data.nopol || '-'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Jenis Mobil:</span>
                        <span class="info-value">${data.jenis_mobil || '-'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Nomor Rangka:</span>
                        <span class="info-value">${data.nomor_rangka || '-'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Telepon Customer:</span>
                        <span class="info-value">${data.telepon_customer || '-'}</span>
                    </div>
                </div>
                
                <div class="info-card">
                    <h3>INFORMASI LAYANAN</h3>
                    <div class="info-item">
                        <span class="info-label">Service Advisor:</span>
                        <span class="info-value">${data.service_advisor || '-'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Tanggal Estimasi:</span>
                        <span class="info-value">${new Date(data.created_at).toLocaleDateString('id-ID')}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status:</span>
                        <span class="info-value"><span class="status-badge ${getStatusClass(data.status)}">${getStatusText(data.status)}</span></span>
                    </div>
                </div>
            </div>
            
            <div class="info-card">
                <h3>KOMPONEN YANG PERLU DIPERBAIKI</h3>
                <ul>
                    ${Array.isArray(komponen) ? 
                        komponen.map(k => `<li>${k}</li>`).join('') : 
                        `<li>${komponen || 'Tidak ada data'}</li>`}
                </ul>
            </div>
            
            <div class="info-card">
                <h3>KETERANGAN</h3>
                <p>${data.keterangan || 'Tidak ada keterangan tambahan'}</p>
            </div>
            
            ${sparepartData && sparepartData.length > 0 ? `
            <div class="info-card">
                <h3>DETAIL SPAREPART</h3>
                <table class="official-table">
                    <thead>
                        <tr>
                            <th>Kode</th>
                            <th>Nama Sparepart</th>
                            <th>Jumlah</th>
                            <th>Ketersediaan</th>
                            <th>Harga</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sparepartData.map(item => `
                            <tr>
                                <td>${item.number || '-'}</td>
                                <td>${item.name || '-'}</td>
                                <td>${item.quantity || '-'}</td>
                                <td>${item.availability || '-'}</td>
                                <td>${formatRupiah(item.price)}</td>
                                <td>${formatRupiah(item.subtotal)}</td>
                            </tr>
                        `).join('')}
                        <tr class="total-row">
                            <td colspan="5" style="text-align: right;">Total Harga:</td>
                            <td>${formatRupiah(data.total_harga)}</td>
                        </tr>
                    </tbody>
                </table>
                <p><strong>Catatan Sparepart:</strong> ${data.catatan_sparepart || '-'}</p>
            </div>
            ` : ''}
            
            ${fotoUrls && fotoUrls.length > 0 ? `
            <div class="info-card">
                <h3>FOTO KONDISI KENDARAAN</h3>
                <div class="foto-grid">
                    ${fotoUrls.map(url => `
                    <div class="foto-item">
                        <img src="${url}" alt="Foto Kendaraan">
                    </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <div class="contact-box">
                <p style="margin: 0; font-weight: bold; font-size: 18px;">Untuk informasi lebih lanjut atau konfirmasi perbaikan, hubungi:</p>
                <p style="margin: 15px 0 0 0;">
                    <strong>Admin Tunas Toyota Batutulis</strong><br>
                    <a href="https://wa.me/6281315389866?text=Halo%20Tunas%20Toyota%20Batutulis,%20saya%20ingin%20konfirmasi%20estimasi%20perbaikan%20kendaraan%20dengan%20nomor%20polisi%20${data.nopol}" 
                        class="wa-link" target="_blank">
                        <i class="fab fa-whatsapp"></i> 081315389866
                    </a> | 
                    <a href="mailto:service@tunastoyota-batutulis.com" class="wa-link">
                        <i class="fas fa-envelope"></i> service@tunastoyota-batutulis.com
                    </a>
                </p>
            </div>
            
            <div class="official-footer">
                <p>Dicetak pada: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}</p>
                <p>© 2023 Tunas Toyota Batutulis. All rights reserved.</p>
            </div>
            `;
        }

        // Fungsi untuk menampilkan error
        function showError(message) {
            document.getElementById('pdf-content').innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <h3>Terjadi Kesalahan</h3>
                    <p>${message}</p>
                    <button onclick="window.location.reload()" style="margin-top: 10px; padding: 8px 15px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Coba Lagi
                    </button>
                </div>
            `;
        }

        // Fungsi utama untuk mengambil data dari Supabase
        async function loadEstimationData() {
            try {
                // Mendapatkan ID dari URL parameter
                const estimationId = getQueryParam('id');
                
                if (!estimationId) {
                    showError('ID estimasi tidak ditemukan dalam URL. Pastikan Anda mengakses halaman dengan parameter ID yang benar.');
                    return;
                }
                
                // Mengambil data dari Supabase
                const { data, error } = await supabase
                    .from('estimasi')
                    .select('*')
                    .eq('id', estimationId)
                    .single();
                    
                if (error) {
                    throw error;
                }
                
                if (!data) {
                    showError('Data estimasi tidak ditemukan untuk ID yang diberikan.');
                    return;
                }
                
                // Render konten PDF
                document.getElementById('pdf-content').innerHTML = generatePDFContent(data);
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Terjadi kesalahan saat memuat data: ' + error.message);
            }
        }

        // Memuat data ketika halaman siap
        document.addEventListener('DOMContentLoaded', loadEstimationData);
    </script>
</body>
</html>
