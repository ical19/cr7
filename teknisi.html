<!DOCTYPE html>
<html lang="id">
    <head>
        <link rel="icon" type="image/x-icon" href="favicon.png">
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Dashboard Teknisi - Sistem Estimasi CR7</title>
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <!-- Tagify CSS -->
        <link href="https://unpkg.com/@yaireo/tagify/dist/tagify.css" rel="stylesheet">
        <!-- Tambahkan di CSS -->
        <style>
            /* Styles untuk image preview di modal edit */
#editImagePreviewContainer .image-preview-container {
    position: relative;
    display: inline-block;
    margin: 5px;
}

#editImagePreviewContainer .image-preview {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid #ddd;
}

#editImagePreviewContainer .remove-image-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: #dc3545;
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
}

.edit-image-preview {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid #ddd;
    cursor: pointer;
}

.edit-image-preview:hover {
    opacity: 0.8;
}
        /* Styles untuk grafik komponen */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
        }

        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            font-size: 1.1rem;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
            text-align: center;
        }

        .dashboard-carousel {
            position: relative;
            overflow: hidden;
        }

        .dashboard-slide {
            display: none;
            transition: transform 0.5s ease;
        }

        .dashboard-slide.active {
            display: block;
        }

        .carousel-indicators {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 10px;
        }

        .carousel-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ddd;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .carousel-indicator.active {
            background-color: var(--accent-color);
        }

        .swipe-hint {
            text-align: center;
            margin-top: 10px;
            color: #6c757d;
            font-size: 0.85rem;
            opacity: 1;
            transition: opacity 0.5s ease, height 0.5s ease, margin 0.5s ease;
            height: auto;
            overflow: hidden;
        }

        .swipe-hint.hidden {
            opacity: 0;
            height: 0;
            margin-top: 0;
        }

        .swipe-hint i {
            margin-right: 5px;
        }
        </style>
        <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --info-color: #2980b9;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --teknisi-color: #3498db;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #2c3e50;
        }

        /* Sidebar Styles */
        .sidebar {
            height: 100vh;
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            padding-top: 20px;
            z-index: 1000;
            box-shadow: 3px 0 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            overflow-y: auto;
        }

        .sidebar-brand {
            padding: 0 20px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .sidebar-brand h4 {
            font-weight: 700;
            margin: 0;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
        }

        .sidebar-menu li {
            margin-bottom: 5px;
        }

        .sidebar-menu a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            padding: 12px 20px;
            display: block;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--accent-color);
            color: white;
        }

        .sidebar-menu i {
            width: 25px;
            margin-right: 10px;
        }

        .user-info {
            position: absolute;
            bottom: 0;
            width: 100%;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            transition: all 0.3s;
        }

        .header {
            background-color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            margin: 0;
            color: var(--primary-color);
            font-weight: 600;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .card-header {
            background-color: white;
            border-bottom: 1px solid #eee;
            padding: 15px 20px;
            font-weight: 600;
            border-radius: 10px 10px 0 0 !important;
            color: var(--primary-color);
        }

        .card-body {
            padding: 20px;
        }

        /* Stats Cards */
        .stats-card {
            text-align: center;
            padding: 15px;
        }

        .stats-icon {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        .stats-number {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .stats-label {
            color: #6c757d;
            font-weight: 500;
            font-size: 0.85rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--secondary-color);
        }

        .form-control,
        .form-select {
            border-radius: 8px;
            padding: 0.75rem 1rem;
            border: 1px solid #e1e5eb;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            color: white;
        }

        /* Table Styles */
        .table th {
            font-weight: 600;
            border-top: none;
            color: var(--primary-color);
        }

        /* Warna dan gaya badge status - urut sesuai flow */
        .status-badge {
            padding: 0.35rem 0.65rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* 1️⃣ Pending → Waiting Part */
        .status-pending {
            background-color: #fff3cd;
            /* kuning lembut */
            color: #856404;
        }

        /* 2️⃣ Progress → ReCheck */
        .status-progress {
            background-color: #cce5ff;
            /* biru muda */
            color: #004085;
        }

        /* 3️⃣ Sent → Waiting SA */
        .status-sent {
            background-color: #d1ecf1;
            /* biru kehijauan */
            color: #0c5460;
        }

        /* 4️⃣ Completed */
        .status-completed {
            background-color: #d4edda;
            /* hijau lembut */
            color: #155724;
        }

        /* 5️⃣ Waiting → Waiting MRA */
        .status-waiting {
            background-color: #f8d7da;
            /* merah muda lembut */
            color: #721c24;
        }

        /* 6️⃣ Done */
        .status-done {
            background-color: #e2e3e5;
            /* abu-abu netral */
            color: #383d41;
        }


        /* Image Upload Styles */
        .image-upload-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .image-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .add-image-btn {
            width: 100px;
            height: 100px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-color: #f8f9fa;
            transition: all 0.3s;
        }

        .add-image-btn:hover {
            border-color: var(--accent-color);
            background-color: #e9ecef;
        }

        .image-preview-container {
            position: relative;
            display: inline-block;
        }

        .remove-image-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #dc3545;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        /* Modal edit estimasi */
        #editEstimasiModal .modal-dialog {
            max-width: 800px;
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .sidebar {
                width: 80px;
                text-align: center;
            }

            .sidebar-brand h4,
            .sidebar-menu span {
                display: none;
            }

            .sidebar-menu i {
                margin-right: 0;
                font-size: 1.25rem;
            }

            .user-info {
                display: none;
            }

            .main-content {
                margin-left: 80px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 15px;
            }

            .sidebar {
                left: -250px;
                box-shadow: none;
            }

            .sidebar.show {
                left: 0;
                box-shadow: 3px 0 15px rgba(0, 0, 0, 0.1);
                z-index: 1050;
            }

            .mobile-header {
                display: flex !important;
                background: white;
                padding: 12px 15px;
                border-radius: 8px;
                margin-bottom: 15px;
                align-items: center;
                justify-content: space-between;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            }

            .mobile-menu-btn {
                display: flex !important;
                background-color: var(--primary-color);
                color: white;
                border: none;
                border-radius: 6px;
                padding: 8px;
                align-items: center;
                justify-content: center;
                width: 40px;
                height: 40px;
            }

            .mobile-title {
                font-weight: 600;
                color: var(--primary-color);
                margin: 0;
                font-size: 1.1rem;
            }

            .stats-card {
                padding: 12px;
            }

            .stats-icon {
                font-size: 1.25rem;
            }

            .stats-number {
                font-size: 1.25rem;
            }

            .stats-label {
                font-size: 0.75rem;
            }

            /* Smaller image preview on mobile */
            .image-preview {
                width: 80px;
                height: 80px;
            }

            .add-image-btn {
                width: 80px;
                height: 80px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        .mobile-header {
            display: none;
        }

        .mobile-menu-btn {
            display: none;
        }

        /* Section Styles */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Tagify Customization */
        .tags-input {
            padding: 0.5rem;
        }

        .tagify__tag {
            background: var(--accent-color);
            color: white;
        }

        .tagify__tag:hover {
            background: #2980b9;
        }

        /* Modal Styles */
        .modal-content {
            border-radius: 10px;
            border: none;
        }

        .modal-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0;
        }

        /* Fix for modal backdrop */
        .modal-backdrop {
            opacity: 0.5 !important;
        }

        /* Grid view for PDF */
        .pdf-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .pdf-grid img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        /* Sparepart Table Styles */
        .sparepart-table {
            margin-top: 20px;
        }

        .sparepart-table th {
            background-color: #f8f9fa;
        }

        .sparepart-table .form-control {
            padding: 0.5rem;
        }

        .total-row {
            font-weight: bold;
            background-color: #f8f9fa;
        }

        .sparepart-actions {
            display: flex;
            gap: 5px;
        }

        /* Toast notification */
        .toast-container {
            z-index: 1100;
        }

        .view-estimasi-foto img {
            max-width: 100%;
            /* jangan lebih lebar dari kontainer */
            height: auto;
            /* tinggi otomatis agar proporsional */
            object-fit: contain;
            /* gambar tetap utuh, tidak terpotong */
            border-radius: 6px;
            /* biar lebih rapi */
        }

        .btn-secondary:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
            opacity: 0.65;
        }

        .btn-warning:disabled {
            background-color: #ffc107;
            border-color: #ffc107;
            opacity: 0.65;
        }

        /* Tambahkan style untuk tabel estimasi */
        #estimasiList td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            font-size: 0.9rem;
        }

        #estimasiList th {
            font-size: 0.85rem;
        }

        .truncate-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
            display: inline-block;
        }

        /* Responsive untuk mobile */
        @media (max-width: 768px) {

            #estimasiList td,
            #estimasiList th {
                font-size: 0.8rem;
                padding: 0.5rem 0.3rem;
            }

            #estimasiList .action-buttons {
                flex-direction: row !important;
                flex-wrap: nowrap;
            }

            #estimasiList .btn-sm {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
            }

            .truncate-text {
                max-width: 80px;
            }

            .card-header .input-group {
                width: 150px !important;
            }
        }

        .btn-outline-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-sm i {
            font-size: 0.8rem;
        }

        /* Tooltip untuk tombol */
        [title] {
            position: relative;
        }

        [title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1000;
        }

        /* Style untuk kedua tabel (estimasi terbaru dan estimasi saya) */
        #recentEstimasi td,
        #estimasiList td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            font-size: 0.9rem;
            vertical-align: middle;
        }

        #recentEstimasi th,
        #estimasiList th {
            font-size: 0.85rem;
            vertical-align: middle;
        }

        #recentEstimasi .action-buttons,
        #estimasiList .action-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: nowrap;
        }

        /* Responsive untuk mobile */
        @media (max-width: 768px) {

            #recentEstimasi td,
            #recentEstimasi th,
            #estimasiList td,
            #estimasiList th {
                font-size: 0.8rem;
                padding: 0.5rem 0.3rem;
            }

            #recentEstimasi .action-buttons,
            #estimasiList .action-buttons {
                flex-direction: row !important;
                flex-wrap: nowrap;
            }

            #recentEstimasi .btn-sm,
            #estimasiList .btn-sm {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
            }

            .truncate-text {
                max-width: 80px;
            }
        }

        @media (max-width: 576px) {

            #recentEstimasi td:nth-child(3),
            #estimasiList td:nth-child(3) {
                max-width: 60px;
            }

            .truncate-text {
                max-width: 60px;
            }

            #recentEstimasi .action-buttons,
            #estimasiList .action-buttons {
                gap: 2px;
            }

            #recentEstimasi .btn-sm,
            #estimasiList .btn-sm {
                padding: 0.15rem 0.3rem;
            }
        }

        /* Tambahkan di bagian CSS */
        .content-section {
            display: none;
            overflow-y: auto;
            max-height: calc(100vh - 100px);
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.5s;
            overflow-y: auto;
        }

        /* Pastikan body selalu bisa di-scroll */
        body {
            overflow-y: auto !important;
        }

        /* Override Bootstrap modal styles */
        .modal-open {
            overflow: auto !important;
            padding-right: 0 !important;
        }

        .modal-open .modal {
            overflow-x: auto;
            overflow-y: auto;
        }

        /* Styles untuk autocomplete dropdown */
        .dropdown-menu {
            max-height: 200px;
            overflow-y: auto;
            z-index: 1060;
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-nopol {
            font-weight: bold;
            color: #2c3e50;
        }

        .suggestion-details {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .suggestion-mobil {
            display: block;
        }

        .suggestion-telepon {
            display: block;
        }

        .suggestion-rangka {
            display: block;
            font-family: monospace;
        }

        .input-group {
            position: relative;
        }

        /* Loading indicator untuk search */
        .loading-indicator {
            display: none;
            position: absolute;
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        /* Responsive styles untuk dropdown */
        @media (max-width: 768px) {
            .dropdown-menu {
                max-height: 150px;
            }

            .suggestion-item {
                padding: 6px 10px;
            }
        }

        .suggestion-item.active {
            background-color: #3498db;
            color: white;
        }

        .suggestion-item.active .suggestion-nopol,
        .suggestion-item.active .suggestion-details {
            color: white;
        }

        /* Styles untuk autocomplete dropdown master kendaraan */
        .dropdown-menu {
            max-height: 250px;
            overflow-y: auto;
            z-index: 1060;
            border: 1px solid #3498db;
        }

        .suggestion-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: all 0.2s;
        }

        .suggestion-item:hover {
            background-color: #e3f2fd;
            transform: translateX(2px);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-nopol {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .suggestion-details {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 4px;
        }

        .suggestion-detail-item {
            display: flex;
            align-items: center;
            margin-bottom: 2px;
        }

        .suggestion-detail-item i {
            width: 16px;
            margin-right: 6px;
            color: #3498db;
        }

        .suggestion-rangka {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        .loading-indicator {
            position: absolute;
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            z-index: 5;
        }

        .input-group {
            position: relative;
        }

        /* Style untuk field yang readonly */
        .form-control[readonly] {
            background-color: #f8f9fa;
            border-color: #e9ecef;
        }

        .form-control[readonly]:focus {
            border-color: #e9ecef;
            box-shadow: none;
        }

        /* Badge untuk info data */
        .data-source-badge {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .dropdown-menu {
                max-height: 200px;
            }

            .suggestion-item {
                padding: 8px 10px;
            }

            .suggestion-nopol {
                font-size: 1rem;
            }
        }

        /* Styles untuk modal detail estimasi */
        #detailEstimasiModal .modal-xl {
            max-width: 1200px;
        }

        #detailEstimasiModal .modal-header {
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        #detailEstimasiModal .card {
            border: 1px solid #e1e5eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        #detailEstimasiModal .card-header {
            border-bottom: 1px solid #e1e5eb;
            padding: 12px 20px;
            background-color: #f8f9fa !important;
        }

        #detailEstimasiModal .card-header h6 {
            margin-bottom: 0;
        }

        #detailEstimasiModal .form-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        #detailEstimasiModal .input-group-text {
            background-color: #f8f9fa;
            border-right: none;
        }

        #detailEstimasiModal .form-control {
            border-left: none;
            background-color: #fafafa;
            color: #495057;
        }

        /* Styling untuk tabel sparepart (read-only) */
        #detailSparepartTable th {
            font-weight: 600;
            font-size: 0.85rem;
            padding: 12px 8px;
            background-color: #f8f9fa !important;
            border-bottom: 2px solid #dee2e6;
        }

        #detailSparepartTable td {
            padding: 10px 8px;
            vertical-align: middle;
            font-size: 0.9rem;
            background-color: #fafafa;
        }

        #detailSparepartTable tbody tr:nth-child(even) td {
            background-color: #f5f5f5;
        }

        /* Komponen list styles */
        .komponen-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 6px 12px;
            margin: 4px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Responsive styles untuk modal detail */
        @media (max-width: 992px) {
            #detailEstimasiModal .modal-body {
                padding: 1.5rem;
            }

            #detailSparepartTable th,
            #detailSparepartTable td {
                padding: 8px 6px;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 768px) {
            #detailEstimasiModal .modal-dialog {
                margin: 0.5rem;
                width: calc(100% - 1rem);
            }

            #detailEstimasiModal .modal-body {
                padding: 1rem;
            }

            #detailEstimasiModal .card-body {
                padding: 1rem;
            }
        }

        /* PERBAIKAN: Styles untuk modal detail estimasi */
        #detailEstimasiModal .modal-xl {
            max-width: 1200px;
        }

        #detailEstimasiModal .modal-header {
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        #detailEstimasiModal .card {
            border: 1px solid #e1e5eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        #detailEstimasiModal .card-header {
            border-bottom: 1px solid #e1e5eb;
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #detailEstimasiModal .card-header.collapsed {
            background-color: #f8f9fa !important;
        }

        #detailEstimasiModal .card-header:not(.collapsed) {
            background-color: #e9ecef !important;
        }

        #detailEstimasiModal .card-header h6 {
            margin-bottom: 0;
        }

        .collapse-icon {
            transition: transform 0.3s;
        }

        #detailEstimasiModal .card-header:not(.collapsed) .collapse-icon {
            transform: rotate(180deg);
        }

        #detailEstimasiModal .form-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        #detailEstimasiModal .input-group-text {
            background-color: #f8f9fa;
            border-right: none;
        }

        #detailEstimasiModal .form-control {
            border-left: none;
            background-color: #fafafa;
            color: #495057;
        }

        /* PERBAIKAN: Default expanded di desktop, collapsed di mobile */
        @media (min-width: 769px) {

            #detailInfoKendaraanCollapse,
            #detailKeteranganCollapse {
                display: block !important;
            }

            #detailEstimasiModal .card-header.collapsed {
                background-color: #f8f9fa !important;
            }

            #detailEstimasiModal .card-header:not(.collapsed) .collapse-icon {
                transform: rotate(180deg);
            }
        }

        @media (max-width: 768px) {

            #detailInfoKendaraanCollapse,
            #detailKeteranganCollapse {
                display: none;
            }

            #detailInfoKendaraanCollapse.show,
            #detailKeteranganCollapse.show {
                display: block;
            }
        }

        /* Komponen list styles */
        .komponen-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 6px 12px;
            margin: 4px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* PERBAIKAN: Fix modal backdrop */
        .modal-backdrop {
            opacity: 0.5 !important;
        }

        .modal-backdrop.show {
            opacity: 0.5 !important;
        }

        /* PERBAIKAN: Pastikan modal tertutup dengan benar */
        body.modal-open {
            overflow: auto !important;
            padding-right: 0 !important;
        }

        /* Styling untuk tabel sparepart (read-only) */
        #detailSparepartTable th {
            font-weight: 600;
            font-size: 0.85rem;
            padding: 12px 8px;
            background-color: #f8f9fa !important;
            border-bottom: 2px solid #dee2e6;
        }

        #detailSparepartTable td {
            padding: 10px 8px;
            vertical-align: middle;
            font-size: 0.9rem;
            background-color: #fafafa;
        }

        #detailSparepartTable tbody tr:nth-child(even) td {
            background-color: #f5f5f5;
        }

        /* Responsive styles untuk modal detail */
        @media (max-width: 992px) {
            #detailEstimasiModal .modal-body {
                padding: 1.5rem;
            }

            #detailSparepartTable th,
            #detailSparepartTable td {
                padding: 8px 6px;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 768px) {
            #detailEstimasiModal .modal-dialog {
                margin: 0.5rem;
                width: calc(100% - 1rem);
            }

            #detailEstimasiModal .modal-body {
                padding: 1rem;
            }

            #detailEstimasiModal .card-body {
                padding: 1rem;
            }

            /* PERBAIKAN: Pastikan modal tertutup dengan benar di mobile */
            .modal.show .modal-dialog {
                transform: none !important;
            }
        }

        /* Tambahkan di CSS untuk tabel edit */
        #editSparepartTable th {
            font-weight: 600;
            font-size: 0.85rem;
            padding: 12px 8px;
            background-color: #f8f9fa !important;
            border-bottom: 2px solid #dee2e6;
        }

        #editSparepartTable td {
            padding: 10px 8px;
            vertical-align: middle;
            font-size: 0.9rem;
            background-color: #fafafa;
        }

        #editSparepartTable tbody tr:nth-child(even) td {
            background-color: #f5f5f5;
        }

        /* Responsive untuk tabel */
        @media (max-width: 768px) {
            #editSparepartTable {
                font-size: 0.75rem;
            }

            #editSparepartTable th,
            #editSparepartTable td {
                padding: 8px 4px;
            }
        }

        /* Styles untuk badge status sparepart */
        .badge-status-ready {
            background-color: #28a745;
            color: white;
        }

        .badge-status-tam {
            background-color: #17a2b8;
            color: white;
        }

        .badge-status-bo {
            background-color: #dc3545;
            color: white;
        }

        .badge-status-empty {
            background-color: #6c757d;
            color: white;
        }

        /* Hover effects untuk badge */
        .badge-status-ready:hover {
            background-color: #218838;
        }

        .badge-status-tam:hover {
            background-color: #138496;
        }

        .badge-status-bo:hover {
            background-color: #c82333;
        }

        .badge-status-empty:hover {
            background-color: #5a6268;
        }

        /* Styles untuk dropdown availability */
        .availability-option-ready {
            color: #28a745;
            font-weight: bold;
        }

        .availability-option-tam {
            color: #17a2b8;
            font-weight: bold;
        }

        .availability-option-bo {
            color: #dc3545;
            font-weight: bold;
        }

        /* Tombol aksi terkunci */
        .disabled-action {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Warna menyesuaikan status baris */
        tr:has(.status-pending) .disabled-action {
            background-color: #fff3cd !important;
            border-color: #ffeeba !important;
            color: #856404 !important;
        }

        tr:has(.status-progress) .disabled-action {
            background-color: #cce5ff !important;
            border-color: #b8daff !important;
            color: #004085 !important;
        }

        tr:has(.status-sent) .disabled-action {
            background-color: #d1ecf1 !important;
            border-color: #bee5eb !important;
            color: #0c5460 !important;
        }

        tr:has(.status-completed) .disabled-action {
            background-color: #d4edda !important;
            border-color: #c3e6cb !important;
            color: #155724 !important;
        }

        tr:has(.status-waiting) .disabled-action {
            background-color: #f8d7da !important;
            border-color: #f5c6cb !important;
            color: #721c24 !important;
        }

        tr:has(.status-done) .disabled-action {
            background-color: #e2e3e5 !important;
            border-color: #d6d8db !important;
            color: #383d41 !important;
        }
        </style>
    </head>
    <body>
        <!-- Mobile Header -->
        <div class="mobile-header">
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
            <h4 class="mobile-title" id="mobileTitle">Dashboard</h4>
            <button class="btn btn-outline-secondary btn-sm" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-brand">
                <h4>
                    CR7
                    <span class="d-none d-md-inline">Estimasi</span>
                </h4>
            </div>
            <ul class="sidebar-menu">
                <li>
                    <a href="#" class="active" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-section="input-estimasi">
                        <i class="fas fa-plus-circle"></i>
                        <span>Input Estimasi</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-section="estimasi-saya">
                        <i class="fas fa-list-alt"></i>
                        <span>Estimasi Saya</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-section="profil">
                        <i class="fas fa-user"></i>
                        <span>Profil</span>
                    </a>
                </li>
            </ul>
            <div class="user-info">
                <p class="mb-0">
                    Halo,
                    <strong id="userName">Teknisi</strong>
                </p>
                <small>
                    Role:
                    <span class="badge status-badge status-progress">Teknisi</span>
                </small>
            </div>
        </div>
        <!-- Main Content -->
        <div class="main-content">
            <div class="header d-none d-md-flex">
                <h2 class="page-title" id="pageTitle">Dashboard</h2>
                <div>
                    <button class="btn btn-outline-secondary btn-sm" id="logoutBtnDesktop">
                        <i class="fas fa-sign-out-alt me-1"></i>
                        Logout
                    </button>
                </div>
            </div>
            <!-- Dashboard Section -->
            <!-- Modifikasi Dashboard Section -->
            <div class="content-section active" id="dashboard">
                <div class="dashboard-carousel">
                    <!-- Slide 1: Stats Cards -->
                    <div class="dashboard-slide active" id="stats-slide">
                        <div class="row">
                            <div class="col-6 col-md-3 mb-3">
                                <div class="card stats-card">
                                    <div class="stats-icon">
                                        <i class="fas fa-clipboard-list"></i>
                                    </div>
                                    <div class="stats-number" id="totalEstimasi">0</div>
                                    <div class="stats-label">Total Estimasi</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <div class="card stats-card">
                                    <div class="stats-icon">
                                        <i class="fas fa-spinner"></i>
                                    </div>
                                    <div class="stats-number" id="estimasiProgress">0</div>
                                    <div class="stats-label">Dalam Proses</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <div class="card stats-card">
                                    <div class="stats-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="stats-number" id="estimasiSelesai">0</div>
                                    <div class="stats-label">Selesai</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <div class="card stats-card">
                                    <div class="stats-icon">
                                        <i class="fas fa-paper-plane"></i>
                                    </div>
                                    <div class="stats-number" id="totalMobil">0</div>
                                    <div class="stats-label">Terkirim ke SA</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Slide 2: Grafik Komponen -->
                    <div class="dashboard-slide" id="chart-slide">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    Grafik Komponen Estimasi Bulan Ini
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <div id="komponenChart" class="chart-placeholder">
                                        <div class="text-center">
                                            <i class="fas fa-spinner fa-spin me-2"></i>
                                            Memuat grafik...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Carousel Indicators -->
                <div class="carousel-indicators">
                    <div class="carousel-indicator active" data-slide="0"></div>
                    <div class="carousel-indicator" data-slide="1"></div>
                </div>
                <!-- Swipe Hint - Akan hilang otomatis -->
                <div class="swipe-hint" id="swipeHint">
                    <i class="fas fa-arrows-left-right"></i>
                    Geser untuk melihat grafik
                </div>
                <!-- Estimasi Terbaru -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Estimasi Terbaru</span>
                                <a href="#" data-section="estimasi-saya2" class="btn btn-sm btn-primary">Lihat Semua</a>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th width="50">No</th>
                                                <th>No. Polisi</th>
                                                <th>Jenis Mobil</th>
                                                <th>Tanggal</th>
                                                <th>Status</th>
                                                <th width="120">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentEstimasi">
                                            <!-- Data akan diisi dari Supabase --></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Input Estimasi Section -->
            <div class="content-section" id="input-estimasi">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Form Input Estimasi Sparepart</span>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="enableManualEdit">
                            <i class="fas fa-edit"></i>
                            Edit Manual
                        </button>
                    </div>
                    <div class="card-body">
                        <form id="estimasiForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="nopol" class="form-label">
                                            Nomor Polisi
                                            <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <input
                                                type="text"
                                                class="form-control"
                                                id="nopol"
                                                placeholder="Contoh: B 1234 ABC"
                                                required
                                                oninput="formatNopol(this)"
                                            >
                                            <button class="btn btn-outline-secondary" type="button" id="searchNopolBtn">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                        <div id="nopolSuggestions" class="dropdown-menu" style="display: none; width: 100%;">
                                            <!-- Suggestions akan muncul di sini --></div>
                                        <small class="form-text text-muted">
                                            Ketik nomor polisi atau klik search untuk
                                        mencari data existing
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="jenisMobil" class="form-label">Jenis Mobil</label>
                                        <span class="text-danger">*</span>
                                    </label>
                                    <select
                                        class="form-select"
                                        id="jenisMobil"
                                        required
                                        disabled
                                    >
                                        <option value="" selected disabled>Pilih Jenis Mobil</option>
                                        <option value="AGYA">AGYA</option>
                                        <option value="ALL NEW AVANZA">ALL NEW AVANZA</option>
                                        <option value="ALPHARD">ALPHARD</option>
                                        <option value="ALPHARD CBU">ALPHARD CBU</option>
                                        <option value="AVANZA">AVANZA</option>
                                        <option value="BZ4X">BZ4X</option>
                                        <option value="CALYA">CALYA</option>
                                        <option value="CAMRY">CAMRY</option>
                                        <option value="C-HR">C-HR</option>
                                        <option value="COROLLA">COROLLA</option>
                                        <option value="COROLLA ALTIS">COROLLA ALTIS</option>
                                        <option value="COROLLA CROSS">COROLLA CROSS</option>
                                        <option value="CROWN">CROWN</option>
                                        <option value="DYNA">DYNA</option>
                                        <option value="ETIOS">ETIOS</option>
                                        <option value="FORTUNER">FORTUNER</option>
                                        <option value="FT86">FT86</option>
                                        <option value="GR YARIS">GR YARIS</option>
                                        <option value="GR YARIS CBU NON TAM">GR YARIS CBU NON TAM</option>
                                        <option value="HARRIER">HARRIER</option>
                                        <option value="HARRIER CBU">HARRIER CBU</option>
                                        <option value="HIACE">HIACE</option>
                                        <option value="HILUX">HILUX</option>
                                        <option value="HILUX RANGGA">HILUX RANGGA</option>
                                        <option value="INNOVA">INNOVA</option>
                                        <option value="INNOVA ZENIX">INNOVA ZENIX</option>
                                        <option value="INNOVA ZENIX HYBRID">INNOVA ZENIX HYBRID</option>
                                        <option value="INNOVA ZENIX Q">INNOVA ZENIX Q</option>
                                        <option value="KIJANG">KIJANG</option>
                                        <option value="LANDCRUISER">LANDCRUISER</option>
                                        <option value="LANDCRUISER 200">LANDCRUISER 200</option>
                                        <option value="LANDCRUISER 300">LANDCRUISER 300</option>
                                        <option value="LANDCRUISER CBU">LANDCRUISER CBU</option>
                                        <option value="LEXUS">LEXUS</option>
                                        <option value="LIMO">LIMO</option>
                                        <option value="MARKX">MARKX</option>
                                        <option value="NAV1">NAV1</option>
                                        <option value="OTHER">OTHER</option>
                                        <option value="PRADO">PRADO</option>
                                        <option value="PREVIA">PREVIA</option>
                                        <option value="PRIUS">PRIUS</option>
                                        <option value="RAIZE">RAIZE</option>
                                        <option value="RUSH">RUSH</option>
                                        <option value="SIENTA">SIENTA</option>
                                        <option value="STARLET">STARLET</option>
                                        <option value="SUPRA">SUPRA</option>
                                        <option value="TRANSMOVER">TRANSMOVER</option>
                                        <option value="VELLFIRE">VELLFIRE</option>
                                        <option value="VELOZ">VELOZ</option>
                                        <option value="VIOS">VIOS</option>
                                        <option value="VOXY">VOXY</option>
                                        <option value="YARIS">YARIS</option>
                                        <option value="YARIS CROSS">YARIS CROSS</option>
                                    </select>
                                    <small class="form-text text-muted">Pilih tipe kendaraan dari daftar.</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="telepon" class="form-label">Nomor Telepon Customer</label>
                                    <input
                                        type="tel"
                                        class="form-control"
                                        id="telepon"
                                        placeholder="Akan terisi otomatis"
                                        required
                                        readonly
                                    >
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="serviceAdvisor" class="form-label">Service Advisor</label>
                                    <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="serviceAdvisor" required>
                                    <option value="" selected disabled>Pilih Service Advisor</option>
                                    <option value="Abdul Azis">Abdul Azis</option>
                                    <option value="Muhammad Hakiki">Muhammad Hakiki</option>
                                    <option value="Ahmad Baidowi">Ahmad Baidowi</option>
                                    <option value="Ade Purwanto">Ade Purwanto</option>
                                    <option value="Akbarudin">Akbarudin</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="nomorRangka" class="form-label">Nomor Rangka</label>
                        <input
                            type="text"
                            class="form-control"
                            id="nomorRangka"
                            placeholder="Akan terisi otomatis"
                            readonly
                        >
                        <small class="form-text text-muted">
                            Nomor rangka biarkan kosong jika tidak ada
                                datanya.
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="komponen" class="form-label">Komponen yang Diestimasi</label>
                        <span class="text-danger">*</span>
                    </label>
                    <input name="tags" class="form-control" placeholder="Tambahkan komponen (tekan enter untuk menambah)">
                    <small class="form-text text-muted">Tekan Enter untuk menambah komponen</small>
                </div>
                <div class="form-group">
                    <label for="keterangan" class="form-label">Keterangan Tambahan</label>
                    <textarea
                        class="form-control"
                        id="keterangan"
                        rows="3"
                        placeholder="Tambahkan keterangan jika diperlukan"
                    ></textarea>
                </div>
                <!-- <div class="form-group">
                            <label class="form-label">Foto Estimasi (Opsional, Maks 5 gambar)</label>
                            <div class="image-upload-container" id="imageUploadContainer">
                                <div class="add-image-btn" id="addImageBtn">
                                    <i class="fas fa-plus"></i>
                                </div>
                                <input type="file" id="fotoEstimasi" multiple accept="image/*" style="display: none;">
                            </div>
                            <small class="form-text text-muted">Klik + untuk menambah gambar. Gambar akan dikompres
                                otomatis.</small>
                        </div> -->
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Info:</strong>
                    Data kendaraan akan dicari dari database master. Jika tidak
                            ditemukan, Anda dapat mengisi manual dengan mengklik tombol di bawah.
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="enableManualEdit">
                        <i class="fas fa-edit"></i>
                        Edit Manual
                    </button>
                </div>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="fas fa-save me-2"></i>
                    Simpan Estimasi
                </button>
            </form>
        </div>
    </div>
</div>
<!-- Estimasi Saya Section -->
<div class="content-section" id="estimasi-saya">
    <!-- Ganti card estimasi saya dengan ini -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Daftar Estimasi Saya</span>
            <div class="d-flex gap-2">
                <div class="input-group input-group-sm" style="width: 200px;">
                    <input
                        type="text"
                        id="searchInput"
                        class="form-control"
                        placeholder="Cari no. polisi..."
                    >
                    <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <button class="btn btn-outline-secondary btn-sm" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th width="50">No</th>
                            <th>No. Polisi</th>
                            <th>Jenis Mobil</th>
                            <th>Komponen</th>
                            <th>Tanggal</th>
                            <th>Status</th>
                            <th width="120">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="estimasiList">
                        <!-- Data akan diisi dari Supabase --></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- Profil Section -->
<div class="content-section" id="profil">
    <div class="card">
        <div class="card-header">
            Profil Saya
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input
                            type="text"
                            class="form-control"
                            id="profileEmail"
                            readonly
                        >
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <input
                            type="text"
                            class="form-control"
                            id="profileRole"
                            readonly
                        >
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Bergabung Pada</label>
                <input
                    type="text"
                    class="form-control"
                    id="profileCreated"
                    readonly
                >
            </div>
        </div>
    </div>
</div>
</div>
<!-- Modal untuk Detail Estimasi - PERBAIKAN -->
<div
    class="modal fade"
    id="detailEstimasiModal"
    tabindex="-1"
    aria-hidden="true"
>
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>
                    Detail Estimasi
                </h5>
                <button
                    type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body p-4">
                <!-- Informasi Utama (Collapsible) -->
                <div class="card mb-3">
                    <div
                        class="card-header bg-light d-flex justify-content-between align-items-center collapsed"
                        data-bs-toggle="collapse"
                        data-bs-target="#detailInfoKendaraanCollapse"
                        aria-expanded="false"
                    >
                        <h6 class="mb-0">
                            <i class="fas fa-car me-2"></i>
                            Informasi Kendaraan
                        </h6>
                        <i class="fas fa-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse" id="detailInfoKendaraanCollapse">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label fw-semibold">Nomor Polisi</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-id-card"></i>
                                            </span>
                                            <input
                                                type="text"
                                                class="form-control"
                                                id="detailNopol"
                                                readonly
                                            >
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label fw-semibold">Jenis Mobil</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-car-side"></i>
                                            </span>
                                            <input
                                                type="text"
                                                class="form-control"
                                                id="detailJenisMobil"
                                                readonly
                                            >
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label fw-semibold">Nomor Telepon Customer</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-phone"></i>
                                            </span>
                                            <input
                                                type="tel"
                                                class="form-control"
                                                id="detailTelepon"
                                                readonly
                                            >
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label fw-semibold">Service Advisor</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-user-tie"></i>
                                            </span>
                                            <input
                                                type="text"
                                                class="form-control"
                                                id="detailServiceAdvisor"
                                                readonly
                                            >
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-12">
                                    <div class="form-group">
                                        <label class="form-label fw-semibold">Nomor Rangka</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-barcode"></i>
                                            </span>
                                            <input
                                                type="text"
                                                class="form-control"
                                                id="detailNomorRangka"
                                                readonly
                                            >
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Komponen yang Diestimasi -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="fas fa-tools me-2"></i>
                            Komponen yang Diestimasi
                            <span class="badge bg-primary ms-2" id="detailKomponenCount">0 Komponen</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="detailKomponenList">
                            <!-- Komponen akan diisi melalui JavaScript --></div>
                    </div>
                </div>
                <!-- Detail Sparepart (Read-only) -->
                <div class="card mb-3">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            Detail Sparepart
                            <span class="badge bg-secondary ms-2" id="detailTotalSparepartCount">0 Item</span>
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0" id="detailSparepartTable">
                                <thead class="table-light">
                                    <tr>
                                        <th width="35%">Nama Komponen</th>
                                        <th width="25%">Harga Satuan</th>
                                        <th width="5%">jml</th>
                                        <th width="25%">subtotal</th>
                                        <th width="10%" class="text-center">status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Baris sparepart akan diisi melalui JavaScript --></tbody>
                                <tfoot class="table-secondary">
                                    <tr>
                                        <td colspan="2" class="text-end fw-bold">Total Harga:</td>
                                        <td colspan="3" class="fw-bold" id="detailTotalHargaSparepart">Rp 0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Keterangan Tambahan (Collapsible) -->
                <div class="card mb-3">
                    <div
                        class="card-header bg-light d-flex justify-content-between align-items-center collapsed"
                        data-bs-toggle="collapse"
                        data-bs-target="#detailKeteranganCollapse"
                        aria-expanded="false"
                    >
                        <h6 class="mb-0">
                            <i class="fas fa-sticky-note me-2"></i>
                            Keterangan Tambahan
                        </h6>
                        <i class="fas fa-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse" id="detailKeteranganCollapse">
                        <div class="card-body">
                            <div class="form-group">
                                <textarea
                                    class="form-control"
                                    id="detailKeterangan"
                                    rows="3"
                                    readonly
                                ></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Foto Estimasi -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="fas fa-images me-2"></i>
                            Foto Estimasi
                            <span class="badge bg-info ms-2" id="detailFotoCount">0 Foto</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="detailFotoContainer" class="image-upload-container">
                            <!-- Foto akan diisi melalui JavaScript --></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <div class="d-flex flex-wrap justify-content-between w-100 align-items-center">
                    <div>
                        <span class="badge bg-info" id="detailStatusBadge">Status</span>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>
                            Tutup
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="detailPrintA5">
                            <i class="fas fa-print me-1"></i>
                            Cetak A5
                        </button>
                        <button type="button" class="btn btn-info" id="detailPrintA4">
                            <i class="fas fa-print me-1"></i>
                            Cetak A4
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal untuk Edit Estimasi -->
<div
    class="modal fade"
    id="editEstimasiModal"
    tabindex="-1"
    aria-hidden="true"
>
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>
                    Edit Estimasi
                </h5>
                <button
                    type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body p-4">
                <form id="editEstimasiForm">
                    <input type="hidden" id="editEstimasiId">
                    <!-- Informasi Utama (Collapsible) -->
                    <div class="card mb-3">
                        <div
                            class="card-header bg-light d-flex justify-content-between align-items-center collapsed"
                            data-bs-toggle="collapse"
                            data-bs-target="#infoKendaraanCollapse"
                            aria-expanded="false"
                        >
                            <h6 class="mb-0">
                                <i class="fas fa-car me-2"></i>
                                Informasi Kendaraan
                            </h6>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </div>
                        <div class="collapse" id="infoKendaraanCollapse">
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editNopol" class="form-label fw-semibold">
                                                Nomor Polisi
                                                <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-id-card"></i>
                                                </span>
                                                <input
                                                    type="text"
                                                    class="form-control"
                                                    id="editNopol"
                                                    required
                                                    oninput="formatNopol(this)"
                                                    placeholder="Contoh: B 1234 ABC"
                                                >
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editJenisMobil" class="form-label fw-semibold">
                                                Jenis Mobil
                                                <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-car-side"></i>
                                                </span>
                                                <select class="form-select" id="editJenisMobil" required>
                                                    <option value="" selected disabled>Pilih Jenis Mobil</option>
                                                    <option value="AGYA">AGYA</option>
                                                    <option value="ALL NEW AVANZA">ALL NEW AVANZA</option>
                                                    <option value="ALPHARD">ALPHARD</option>
                                                    <option value="ALPHARD CBU">ALPHARD CBU</option>
                                                    <option value="AVANZA">AVANZA</option>
                                                    <option value="BZ4X">BZ4X</option>
                                                    <option value="CALYA">CALYA</option>
                                                    <option value="CAMRY">CAMRY</option>
                                                    <option value="C-HR">C-HR</option>
                                                    <option value="COROLLA">COROLLA</option>
                                                    <option value="COROLLA ALTIS">COROLLA ALTIS</option>
                                                    <option value="COROLLA CROSS">COROLLA CROSS</option>
                                                    <option value="CROWN">CROWN</option>
                                                    <option value="DYNA">DYNA</option>
                                                    <option value="ETIOS">ETIOS</option>
                                                    <option value="FORTUNER">FORTUNER</option>
                                                    <option value="FT86">FT86</option>
                                                    <option value="GR YARIS">GR YARIS</option>
                                                    <option value="GR YARIS CBU NON TAM">
                                                        GR YARIS CBU NON TAM
                                                    </option>
                                                    <option value="HARRIER">HARRIER</option>
                                                    <option value="HARRIER CBU">HARRIER CBU</option>
                                                    <option value="HIACE">HIACE</option>
                                                    <option value="HILUX">HILUX</option>
                                                    <option value="HILUX RANGGA">HILUX RANGGA</option>
                                                    <option value="INNOVA">INNOVA</option>
                                                    <option value="INNOVA ZENIX">INNOVA ZENIX</option>
                                                    <option value="INNOVA ZENIX HYBRID">INNOVA ZENIX HYBRID</option>
                                                    <option value="INNOVA ZENIX Q">INNOVA ZENIX Q</option>
                                                    <option value="KIJANG">KIJANG</option>
                                                    <option value="LANDCRUISER">LANDCRUISER</option>
                                                    <option value="LANDCRUISER 200">LANDCRUISER 200</option>
                                                    <option value="LANDCRUISER 300">LANDCRUISER 300</option>
                                                    <option value="LANDCRUISER CBU">LANDCRUISER CBU</option>
                                                    <option value="LEXUS">LEXUS</option>
                                                    <option value="LIMO">LIMO</option>
                                                    <option value="MARKX">MARKX</option>
                                                    <option value="NAV1">NAV1</option>
                                                    <option value="OTHER">OTHER</option>
                                                    <option value="PRADO">PRADO</option>
                                                    <option value="PREVIA">PREVIA</option>
                                                    <option value="PRIUS">PRIUS</option>
                                                    <option value="RAIZE">RAIZE</option>
                                                    <option value="RUSH">RUSH</option>
                                                    <option value="SIENTA">SIENTA</option>
                                                    <option value="STARLET">STARLET</option>
                                                    <option value="SUPRA">SUPRA</option>
                                                    <option value="TRANSMOVER">TRANSMOVER</option>
                                                    <option value="VELLFIRE">VELLFIRE</option>
                                                    <option value="VELOZ">VELOZ</option>
                                                    <option value="VIOS">VIOS</option>
                                                    <option value="VOXY">VOXY</option>
                                                    <option value="YARIS">YARIS</option>
                                                    <option value="YARIS CROSS">YARIS CROSS</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editTelepon" class="form-label fw-semibold">
                                                Nomor Telepon
                                                    Customer
                                                <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-phone"></i>
                                                </span>
                                                <input
                                                    type="tel"
                                                    class="form-control"
                                                    id="editTelepon"
                                                    required
                                                    placeholder="Contoh: 081234567890"
                                                >
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editServiceAdvisor" class="form-label fw-semibold">
                                                Service
                                                    Advisor
                                                <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-user-tie"></i>
                                                </span>
                                                <select class="form-select" id="editServiceAdvisor" required>
                                                    <option value="" selected disabled>
                                                        Pilih Service Advisor
                                                    </option>
                                                    <option value="Abdul Azis">Abdul Azis</option>
                                                    <option value="Muhammad Hakiki">Muhammad Hakiki</option>
                                                    <option value="Ahmad Baidowi">Ahmad Baidowi</option>
                                                    <option value="Ade Purwanto">Ade Purwanto</option>
                                                    <option value="Akbarudin">Akbarudin</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-12">
                                        <div class="form-group">
                                            <label for="editNomorRangka" class="form-label fw-semibold">
                                                Nomor
                                                    Rangka
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-barcode"></i>
                                                </span>
                                                <input
                                                    type="text"
                                                    class="form-control"
                                                    id="editNomorRangka"
                                                    placeholder="Masukkan nomor rangka kendaraan"
                                                >
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Komponen yang Diestimasi -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-tools me-2"></i>
                                Komponen yang Diestimasi
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="editKomponen" class="form-label fw-semibold">
                                    Komponen
                                    <span class="text-danger">*</span>
                                </label>
                                <input
                                    name="editTags"
                                    class="form-control"
                                    id="editKomponenInput"
                                    placeholder="Tambahkan komponen (tekan enter untuk menambah)"
                                >
                                <small class="form-text text-muted">Tekan Enter untuk menambah komponen.</small>
                            </div>
                        </div>
                    </div>
                    <!-- Detail Sparepart (Read-only) -->
                    <div class="card mb-3">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>
                                Detail Sparepart
                                <span class="badge bg-secondary ms-2" id="totalSparepartCount">0 Item</span>
                            </h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-bordered mb-0" id="editSparepartTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="30%">Nama Komponen</th>
                                            <th width="15%">No. Part</th>
                                            <!-- TAMBAH KOLOM INI -->
                                            <th width="20%">Harga Satuan</th>
                                            <th width="5%">jml</th>
                                            <th width="20%">total</th>
                                            <!-- UBAH subtotal → total -->
                                            <th width="10%" class="text-center">status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Baris sparepart akan diisi melalui JavaScript --></tbody>
                                    <tfoot class="table-secondary">
                                        <tr>
                                            <td colspan="4" class="text-end fw-bold">Total Harga:</td>
                                            <td colspan="2" class="fw-bold" id="totalHargaSparepart">Rp 0</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Keterangan Tambahan (Collapsible) -->
                    <div class="card mb-3">
                        <div
                            class="card-header bg-light d-flex justify-content-between align-items-center collapsed"
                            data-bs-toggle="collapse"
                            data-bs-target="#keteranganCollapse"
                            aria-expanded="false"
                        >
                            <h6 class="mb-0">
                                <i class="fas fa-sticky-note me-2"></i>
                                Keterangan Tambahan
                            </h6>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </div>
                        <div class="collapse" id="keteranganCollapse">
                            <div class="card-body">
                                <div class="form-group">
                                    <textarea
                                        class="form-control"
                                        id="editKeterangan"
                                        rows="3"
                                        placeholder="Tambahkan keterangan jika diperlukan"
                                    ></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Upload Gambar (Opsional, Maks 15 gambar) -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-images me-2"></i>
                                Upload Gambar (Opsional)
                                <span class="badge bg-info ms-2" id="editFotoCount">0/15 Foto</span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label fw-semibold">Foto Estimasi</label>
                                <div class="image-upload-container" id="editImageUploadContainer">
                                    <div class="add-image-btn" id="editAddImageBtn">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <input
                                        type="file"
                                        id="editFotoEstimasi"
                                        multiple
                                        accept="image/*"
                                        style="display: none;"
                                    >
                                </div>
                                <small class="form-text text-muted">
                                    Klik + untuk menambah gambar. Maksimal 15 gambar. Gambar akan dikompres otomatis.
                                </small>
                            </div>
                            <div id="editImagePreviewContainer" class="image-upload-container mt-3">
                                <!-- Preview gambar yang sudah ada akan ditampilkan di sini --></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <div class="d-flex flex-wrap justify-content-between w-100 align-items-center">
                    <div>
                        <button type="button" class="btn btn-danger me-2" id="deleteEstimasiBtn">
                            <i class="fas fa-trash me-1"></i>
                            Hapus
                        </button>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>
                            Batal
                        </button>
                        <button type="button" class="btn btn-warning" id="sendToSparepartBtn">
                            <i class="fas fa-paper-plane me-1"></i>
                            Kirim ke Sparepart
                        </button>
                        <button type="button" class="btn btn-info" id="sendToSABtn">
                            <i class="fas fa-share me-1"></i>
                            Kirim ke SA
                        </button>
                        <button type="button" class="btn btn-success" id="updateEstimasiBtn">
                            <i class="fas fa-save me-1"></i>
                            Simpan Perubahan
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
        /* Custom styles untuk modal edit estimasi */
        #editEstimasiModal .modal-xl {
            max-width: 1200px;
        }

        #editEstimasiModal .modal-header {
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        #editEstimasiModal .card {
            border: 1px solid #e1e5eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        #editEstimasiModal .card-header {
            border-bottom: 1px solid #e1e5eb;
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #editEstimasiModal .card-header.collapsed {
            background-color: #f8f9fa !important;
        }

        #editEstimasiModal .card-header:not(.collapsed) {
            background-color: #e9ecef !important;
        }

        #editEstimasiModal .card-header h6 {
            margin-bottom: 0;
        }

        .collapse-icon {
            transition: transform 0.3s;
        }

        #editEstimasiModal .card-header:not(.collapsed) .collapse-icon {
            transform: rotate(180deg);
        }

        #editEstimasiModal .form-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        #editEstimasiModal .input-group-text {
            background-color: #f8f9fa;
            border-right: none;
        }

        #editEstimasiModal .form-control,
        #editEstimasiModal .form-select {
            border-left: none;
            transition: all 0.3s;
        }

        #editEstimasiModal .form-control:focus,
        #editEstimasiModal .form-select:focus {
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.15);
            border-color: #3498db;
        }

        /* Styling untuk tabel sparepart (read-only) */
        #editSparepartTable th {
            font-weight: 600;
            font-size: 0.85rem;
            padding: 12px 8px;
            background-color: #f8f9fa !important;
            border-bottom: 2px solid #dee2e6;
        }

        #editSparepartTable td {
            padding: 10px 8px;
            vertical-align: middle;
            font-size: 0.9rem;
            background-color: #fafafa;
        }

        #editSparepartTable tbody tr:nth-child(even) td {
            background-color: #f5f5f5;
        }

        /* Styling untuk tombol aksi */
        #editEstimasiModal .btn {
            border-radius: 6px;
            font-weight: 500;
            padding: 8px 16px;
            transition: all 0.3s;
        }

        #editEstimasiModal .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Responsive styles */
        @media (max-width: 1200px) {
            #editEstimasiModal .modal-xl {
                max-width: 95%;
                margin: 1rem auto;
            }
        }

        @media (max-width: 992px) {
            #editEstimasiModal .modal-body {
                padding: 1.5rem;
            }

            #editSparepartTable th,
            #editSparepartTable td {
                padding: 8px 6px;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 768px) {
            #editEstimasiModal .modal-dialog {
                margin: 0.5rem;
                width: calc(100% - 1rem);
            }

            #editEstimasiModal .modal-body {
                padding: 1rem;
            }

            #editEstimasiModal .card-body {
                padding: 1rem;
            }

            #editSparepartTable {
                font-size: 0.75rem;
            }

            #editSparepartTable th {
                white-space: nowrap;
            }

            #editEstimasiModal .modal-footer .btn {
                font-size: 0.8rem;
                padding: 6px 12px;
                margin-bottom: 5px;
            }

            #editEstimasiModal .modal-footer .d-flex {
                flex-direction: column;
                align-items: stretch;
            }

            #editEstimasiModal .modal-footer .d-flex>div {
                margin-bottom: 10px;
                width: 100%;
            }

            #editEstimasiModal .modal-footer .btn {
                width: 100%;
                margin: 2px 0;
            }

            /* Default expand semua section di desktop, collapse di mobile */
            #infoKendaraanCollapse,
            #keteranganCollapse {
                display: block;
            }

            @media (max-width: 768px) {

                #infoKendaraanCollapse,
                #keteranganCollapse {
                    display: none;
                }

                #infoKendaraanCollapse.show,
                #keteranganCollapse.show {
                    display: block;
                }
            }
        }

        @media (max-width: 576px) {
            #editEstimasiModal .modal-body {
                padding: 0.5rem;
            }

            #editEstimasiModal .card {
                margin-bottom: 1rem;
            }

            #editSparepartTable {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .input-group-text {
                padding: 6px 8px;
            }

            .form-control,
            .form-select {
                padding: 6px 8px;
            }
        }

        /* Desktop - semua section expanded by default */
        @media (min-width: 769px) {

            #infoKendaraanCollapse,
            #keteranganCollapse {
                display: block !important;
            }

            #editEstimasiModal .card-header.collapsed {
                background-color: #f8f9fa !important;
            }

            #editEstimasiModal .card-header:not(.collapsed) .collapse-icon {
                transform: rotate(180deg);
            }
        }

        /* Styling untuk badge jml sparepart */
        #totalSparepartCount {
            font-size: 0.8rem;
            padding: 4px 8px;
        }

        /* Styling untuk total harga */
        #totalHargaSparepart {
            color: #e74c3c;
            font-size: 1rem;
        }

        /* Tagify customization */
        .tagify__tag {
            background: #3498db;
            color: white;
        }

        .tagify__tag:hover {
            background: #2980b9;
        }

        .tagify__tag__removeBtn {
            color: white;
        }

        .tagify__tag__removeBtn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tagify__input::before {
            color: #6c757d;
        }
</style>
<!-- Bootstrap & jQuery JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Tagify JS -->
<script src="https://unpkg.com/@yaireo/tagify"></script>
<script src="https://unpkg.com/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<!-- Tambahkan di dashboard teknisi jika belum ada -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script>
        // Inisialisasi Supabase
        const supabaseUrl = 'https://pjawwektzazcxakgopou.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBqYXd3ZWt0emF6Y3hha2dvcG91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNjQ5MTUsImV4cCI6MjA3Mzg0MDkxNX0.dNEB80t7LcTsvAtHHqgIeJfxcwmmZNsWxPTIAlrj11c';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Supabase untuk master_kendaraan (database baru)
const supabaseMaster = window.supabase.createClient(
  'https://tnrmflapmskngttmqyzm.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRucm1mbGFwbXNrbmd0dG1xeXptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MjEwMjcsImV4cCI6MjA3Nzk5NzAyN30.YZM3-8kN_xJX5lc51B37bFjXxELUrPrbdQO3BSBDe-A'
);

        // Inisialisasi Tagify
        let tagify;
        let editTagify;

        // Variabel global untuk data user
        let currentUser = null;
        let userProfile = null;
        let currentEstimasiId = null;
        let selectedImages = [];

        // Cek status autentikasi
        checkAuthState();

        // Fungsi untuk cek status autentikasi
        async function checkAuthState() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }

                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    currentUser = user;
                    document.getElementById('userName').textContent = user.email;
                    document.getElementById('profileEmail').value = user.email;
                    document.getElementById('profileCreated').value = new Date(user.created_at).toLocaleDateString('id-ID');

                    // Ambil role dari tabel users
                    const { data: userData, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', user.id)
                        .single();

                    if (!error && userData) {
                        userProfile = userData;
                        document.getElementById('profileRole').value = userData.role;

                        // VALIDASI ROLE
                        if (userData.role !== 'teknisi') {
                            window.location.href = 'index.html';
                            return;
                        }
                    } else {
                        console.error('Error fetching user profile:', error);
                        await createUserProfile(user);
                    }
                }

                // load data dashboard hanya kalau role sesuai
                await loadDashboardData();
                setTimeout(initTagify, 100);
                setTimeout(initEditTagify, 100);
                initImageUpload();

            } catch (error) {
                console.error('Error checking auth state:', error);
                //alert('Terjadi kesalahan: ' + error.message);
            }
        }

        // Variabel untuk menyimpan data kendaraan
        let kendaraanData = [];

        // Fungsi untuk mencari data kendaraan dari tabel master_kendaraan
// Fungsi untuk mencari data kendaraan dari tabel master_kendaraan (database baru)
async function searchKendaraanByNopol(nopol) {
    try {
        if (!nopol || nopol.length < 3) {
            hideSuggestions();
            return [];
        }

        // Tampilkan loading indicator
        showLoadingIndicator(true);

        // Gunakan supabaseMaster untuk koneksi ke database master
        const { data, error } = await supabaseMaster
            .from('master_kendaraan')
            .select('*')
            .ilike('nopol', `%${nopol}%`)
            .order('nopol', { ascending: false })
            .limit(10);

        if (error) throw error;

        // Sembunyikan loading indicator
        showLoadingIndicator(false);

        return data || [];

    } catch (error) {
        console.error('Error searching kendaraan:', error);
        showLoadingIndicator(false);
        return [];
    }
}

        // Fungsi untuk mendapatkan data kendaraan by nomor rangka
// Fungsi untuk mendapatkan data kendaraan by nomor rangka (database baru)
async function getKendaraanByNomorRangka(nomorRangka) {
    try {
        const { data, error } = await supabaseMaster
            .from('master_kendaraan')
            .select('*')
            .eq('nomor_rangka', nomorRangka)
            .single();

        if (error) {
            if (error.code === 'PGRST116') { // Data tidak ditemukan
                return null;
            }
            throw error;
        }

        return data;

    } catch (error) {
        console.error('Error getting kendaraan by nomor rangka:', error);
        return null;
    }
}

        // Fungsi untuk menyimpan data kendaraan ke master
        async function saveToMasterKendaraan(kendaraanData) {
            try {
                const { data, error } = await supabase
                    .from('master_kendaraan')
                    .upsert([
                        {
                            nomor_rangka: kendaraanData.nomor_rangka,
                            nopol: kendaraanData.nopol,
                            jenis_mobil: kendaraanData.jenis_mobil,
                            telepon_customer: kendaraanData.telepon_customer
                        }
                    ], {
                        onConflict: 'nomor_rangka',
                        ignoreDuplicates: false
                    })
                    .select();

                if (error) throw error;

                console.log('Data kendaraan berhasil disimpan ke master:', data);
                return data;

            } catch (error) {
                console.error('Error saving to master kendaraan:', error);
                throw error;
            }
        }

        // Fungsi untuk menampilkan suggestions dropdown
        function showSuggestions(suggestions) {
            const suggestionsContainer = document.getElementById('nopolSuggestions');

            if (suggestions.length === 0) {
                hideSuggestions();
                return;
            }

            let suggestionsHTML = '';

            suggestions.forEach((item, index) => {
                suggestionsHTML += `
            <div class="suggestion-item" data-index="${index}">
                <div class="suggestion-nopol">${item.nopol}</div>
                <div class="suggestion-details">
                    <div class="suggestion-detail-item">
                        <i class="fas fa-car"></i>
                        <span>${item.jenis_mobil || 'Tidak ada data'}</span>
                    </div>
                    <div class="suggestion-detail-item">
                        <i class="fas fa-phone"></i>
                        <span>${item.telepon_customer || 'Tidak ada data'}</span>
                    </div>
                    <div class="suggestion-detail-item">
                        <i class="fas fa-barcode"></i>
                        <span class="suggestion-rangka">${item.nomor_rangka || 'Tidak ada data'}</span>
                    </div>
                </div>
            </div>
        `;
            });

            suggestionsContainer.innerHTML = suggestionsHTML;
            suggestionsContainer.style.display = 'block';

            // Tambahkan event listener untuk setiap suggestion item
            setTimeout(() => {
                document.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', function () {
                        const index = this.getAttribute('data-index');
                        selectSuggestion(suggestions[index]);
                    });
                });
            }, 100);
        }

        // Fungsi untuk memilih suggestion dan mengisi form
        function selectSuggestion(selectedData) {
            // Isi form dengan data yang dipilih
            document.getElementById('nopol').value = selectedData.nopol;
            document.getElementById('jenisMobil').value = selectedData.jenis_mobil || '';
            document.getElementById('telepon').value = selectedData.telepon_customer || '';
            document.getElementById('nomorRangka').value = selectedData.nomor_rangka || '';

            // Tambahkan badge info untuk menunjukkan data dari database
            addDataSourceBadge();

            // Sembunyikan dropdown
            hideSuggestions();

            // Fokus ke field service advisor
            document.getElementById('serviceAdvisor').focus();
        }

        // Fungsi untuk menambahkan badge info
        function addDataSourceBadge() {
            // Hapus badge yang sudah ada
            removeDataSourceBadge();

            // Tambahkan badge ke setiap field
            const fields = ['jenisMobil', 'telepon', 'nomorRangka'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    const badge = document.createElement('span');
                    badge.className = 'data-source-badge badge bg-success';
                    badge.innerHTML = '<i class="fas fa-database"></i> DB';
                    badge.title = 'Data dari database master';
                    field.parentElement.style.position = 'relative';
                    field.parentElement.appendChild(badge);
                }
            });
        }

        // Fungsi untuk mendapatkan class badge berdasarkan ketersediaan
        function getAvailabilityBadgeClass(availability) {
            switch (availability) {
                case 'ready': return 'badge-status-ready';
                case 'tam': return 'badge-status-tam';
                case 'bo': return 'badge-status-bo';
                case 'kosong': return 'badge-status-empty';
                default: return 'badge-status-empty';
            }
        }

        // Fungsi untuk mendapatkan teks ketersediaan
        function getAvailabilityText(availability) {
            switch (availability) {
                case 'ready': return 'ADA';
                case 'tam': return 'TAM';
                case 'bo': return 'BO';
                case 'kosong': return 'KOSONG';
                default: return 'KOSONG';
            }
        }

        // Fungsi untuk menghapus badge info
        function removeDataSourceBadge() {
            document.querySelectorAll('.data-source-badge').forEach(badge => {
                badge.remove();
            });
        }

        // Fungsi untuk enable manual editing
        function enableManualEditing() {
            const fields = ['jenisMobil', 'telepon', 'nomorRangka'];

            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.readOnly = false;
                    field.placeholder = 'Isi manual...';
                    field.style.backgroundColor = '#fff';
                }
            });

            // Hapus badge
            removeDataSourceBadge();

            // Show success message
            showToast('success', 'Edit Manual Diaktifkan', 'Anda sekarang dapat mengedit data manual');

            // Focus ke jenis mobil
            document.getElementById('jenisMobil').focus();
        }

        // Fungsi untuk reset form ke keadaan awal
        function resetForm() {
            document.getElementById('estimasiForm').reset();
            removeDataSourceBadge();

            // Set field ke readonly lagi
            const fields = ['jenisMobil', 'telepon', 'nomorRangka'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.readOnly = true;
                    field.placeholder = 'Akan terisi otomatis';
                    field.style.backgroundColor = '#f8f9fa';
                }
            });

            // Reset tagify
            if (tagify) {
                tagify.removeAllTags();
            }

            // Reset images
            selectedImages = [];
            document.getElementById('imageUploadContainer').innerHTML = `
        <div class="add-image-btn" id="addImageBtn">
            <i class="fas fa-plus"></i>
        </div>
        <input type="file" id="fotoEstimasi" multiple accept="image/*" style="display: none;">
    `;
            initImageUpload();
        }

        // Modifikasi form submission untuk menyimpan ke master kendaraan
$('#estimasiForm').submit(async function (e) {
    e.preventDefault();

    const nopol = $('#nopol').val();
    const jenisMobil = $('#jenisMobil').val();
    const telepon = $('#telepon').val();
    const serviceAdvisor = $('#serviceAdvisor').val();
    const nomorRangka = $('#nomorRangka').val();
    const keterangan = $('#keterangan').val();

    // Dapatkan tag dari Tagify
    const tags = tagify.value.map(tag => tag.value);

    if (!nopol || !jenisMobil || !telepon || !serviceAdvisor || tags.length === 0) {
        showToast('error', 'Error', 'Harap isi semua field yang diperlukan!');
        return;
    }

    try {
        // Tampilkan loading
        const submitBtn = $('#submitBtn');
        submitBtn.html('<span class="loading-spinner"></span> Menyimpan...');
        submitBtn.prop('disabled', true);

        // 1. Upload foto jika ada - INI YANG DITAMBAHKAN
        let fotoUrls = [];
        console.log("🖼️ Jumlah gambar yang akan diupload:", selectedImages.length);
        
        if (selectedImages.length > 0) {
            for (let i = 0; i < selectedImages.length; i++) {
                const image = selectedImages[i];
                console.log(`📤 Uploading gambar ${i+1}/${selectedImages.length}:`, image.name);
                
                const url = await uploadFoto(image);
                if (url) {
                    fotoUrls.push(url);
                    console.log(`✅ Gambar ${i+1} berhasil diupload:`, url);
                } else {
                    console.error(`❌ Gagal upload gambar ${i+1}`);
                }
            }
        } else {
            console.log("ℹ️ Tidak ada gambar yang diupload");
        }

        console.log("📊 URL foto yang akan disimpan:", fotoUrls);

        // 2. Simpan data estimasi
        const { data, error } = await supabase
            .from('estimasi')
            .insert([
                {
                    nopol: nopol,
                    jenis_mobil: jenisMobil,
                    telepon_customer: telepon,
                    service_advisor: serviceAdvisor,
                    nomor_rangka: nomorRangka,
                    komponen: tags,
                    keterangan: keterangan,
                    foto_url: fotoUrls, // Pastikan ini array
                    teknisi_id: currentUser.id,
                    status: 'pending'
                }
            ])
            .select();

        if (error) throw error;

        // Tampilkan pesan sukses
        showToast('success', 'Berhasil', `Estimasi berhasil disimpan! ${fotoUrls.length > 0 ? fotoUrls.length + ' gambar diupload.' : ''}`);

        // Reset form
        resetForm();

        // Reload data dashboard
        await loadDashboardData();

    } catch (error) {
        console.error('❌ Error saving estimation:', error);
        showToast('error', 'Error', 'Terjadi kesalahan saat menyimpan estimasi: ' + error.message);
    } finally {
        // Reset button
        $('#submitBtn').html('<i class="fas fa-save me-2"></i> Simpan Estimasi');
        $('#submitBtn').prop('disabled', false);
    }
});

        // Inisialisasi di Document Ready
        $(document).ready(function () {

            // Inisialisasi autocomplete untuk master kendaraan
            setupNopolAutocomplete();

            // Event listener untuk tombol edit manual
            $('#enableManualEdit').click(function () {
                enableManualEditing();
            });

            // Event listener untuk reset form ketika berpindah section
            $('.sidebar-menu a').click(function (e) {
                if ($(this).data('section') !== 'input-estimasi') {
                    resetForm();
                }
            });
        });

        // Fungsi untuk menyembunyikan suggestions dropdown
        function hideSuggestions() {
            const suggestionsContainer = document.getElementById('nopolSuggestions');
            suggestionsContainer.style.display = 'none';
        }

        // Fungsi untuk menampilkan/menyembunyikan loading indicator
        function showLoadingIndicator(show) {
            let loadingIndicator = document.getElementById('loadingIndicator');

            if (!loadingIndicator) {
                loadingIndicator = document.createElement('div');
                loadingIndicator.id = 'loadingIndicator';
                loadingIndicator.className = 'loading-indicator';
                loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                document.querySelector('.input-group').appendChild(loadingIndicator);
            }

            loadingIndicator.style.display = show ? 'block' : 'none';
        }

        // Fungsi untuk menangani pencarian otomatis saat mengetik
        // Fungsi untuk menangani pencarian otomatis saat mengetik
        function setupNopolAutocomplete() {
            const nopolInput = document.getElementById('nopol');
            const searchBtn = document.getElementById('searchNopolBtn');
            let searchTimeout;

            // Event listener untuk input perubahan
            nopolInput.addEventListener('input', function () {
                clearTimeout(searchTimeout);

                searchTimeout = setTimeout(async () => {
                    const nopol = this.value.trim();
                    if (nopol.length >= 3) {
                        const suggestions = await searchKendaraanByNopol(nopol);
                        showSuggestions(suggestions);
                    } else {
                        hideSuggestions();
                    }
                }, 500);
            });

            // Event listener untuk tombol search
            searchBtn.addEventListener('click', async function () {
                const nopol = nopolInput.value.trim();
                if (nopol) {
                    const suggestions = await searchKendaraanByNopol(nopol);
                    showSuggestions(suggestions);
                }
            });

            // Event listener untuk menutup dropdown ketika klik di luar
            document.addEventListener('click', function (e) {
                if (!e.target.closest('#nopol') && !e.target.closest('#nopolSuggestions')) {
                    hideSuggestions();
                }
            });

            // Event listener untuk keyboard navigation - PERBAIKAN DI SINI
            nopolInput.addEventListener('keydown', function (e) {
                const suggestionsContainer = document.getElementById('nopolSuggestions');
                const visibleSuggestions = suggestionsContainer.style.display !== 'none';

                if (visibleSuggestions) {
                    const suggestions = document.querySelectorAll('.suggestion-item');
                    let activeSuggestion = document.querySelector('.suggestion-item.active');

                    switch (e.key) {
                        case 'ArrowDown':
                            e.preventDefault();
                            if (!activeSuggestion) {
                                suggestions[0]?.classList.add('active');
                            } else {
                                activeSuggestion.classList.remove('active');
                                const next = activeSuggestion.nextElementSibling;
                                if (next) next.classList.add('active');
                            }
                            break;

                        case 'ArrowUp':
                            e.preventDefault();
                            if (activeSuggestion) {
                                activeSuggestion.classList.remove('active');
                                const prev = activeSuggestion.previousElementSibling;
                                if (prev) prev.classList.add('active');
                            }
                            break;

                        case 'Enter':
                            e.preventDefault();
                            if (activeSuggestion) {
                                const index = activeSuggestion.getAttribute('data-index');
                                // Pindahkan await ke fungsi async terpisah
                                handleEnterKeySelection(nopolInput.value, index);
                            }
                            break;

                        case 'Escape':
                            hideSuggestions();
                            break;
                    }
                }
            });
        }

        // Fungsi terpisah untuk menangani Enter key
        async function handleEnterKeySelection(nopol, index) {
            const suggestions = await searchKendaraanByNopol(nopol);
            if (suggestions[index]) {
                selectSuggestion(suggestions[index]);
            }
        }

        // Fungsi untuk auto-fill form jika hanya ada 1 hasil
        async function autoFillIfSingleResult(nopol) {
            const suggestions = await searchKendaraanByNopol(nopol);

            if (suggestions.length === 1) {
                // Tampilkan konfirmasi kepada user
                if (confirm(`Data ditemukan untuk nomor polisi ${nopol}. Isi form otomatis?`)) {
                    selectSuggestion(suggestions[0]);
                }
            } else if (suggestions.length > 1) {
                showSuggestions(suggestions);
            }
        }

        // Tambahkan fungsi ini di bagian atas script
        function enableBodyScroll() {
            // Hapus semua kelas dan style yang mencegah scrolling
            $('body').removeClass('modal-open');
            $('body').css({
                'overflow': 'auto',
                'padding-right': '0px'
            });

            // Hapus semua backdrop modal
            $('.modal-backdrop').remove();

            // Force reset pada element body
            document.body.style.overflow = 'auto';
            document.body.style.paddingRight = '0px';

            // Hapus inline styles yang mungkin ditambahkan oleh Bootstrap
            document.body.removeAttribute('style');
        }

        // Panggil fungsi ini ketika berpindah section
        $('.sidebar-menu a').click(function (e) {
            e.preventDefault();

            // Enable scrolling terlebih dahulu
            enableBodyScroll();

            // ... kode navigasi yang sudah ada ...

            // Pastikan kembali scrolling di-enable setelah navigasi
            setTimeout(enableBodyScroll, 100);
        });

        // Variabel global untuk menyimpan data sparepart
        let sparepartData = [];
        let originalSpareparts = [];

        async function openEditEstimasi(id) {
            try {
                const { data, error } = await supabase
                    .from('estimasi')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                // Isi form dengan data estimasi
                document.getElementById('editEstimasiId').value = data.id;
                document.getElementById('editNopol').value = data.nopol;
                document.getElementById('editJenisMobil').value = data.jenis_mobil;
                document.getElementById('editTelepon').value = data.telepon_customer;
                document.getElementById('editServiceAdvisor').value = data.service_advisor;
                document.getElementById('editNomorRangka').value = data.nomor_rangka || '';
                document.getElementById('editKeterangan').value = data.keterangan || '';

                // Simpan data sparepart asli
                originalSpareparts = Array.isArray(data.sparepart_data)
                    ? data.sparepart_data
                    : (data.sparepart_data ? JSON.parse(data.sparepart_data) : []);

                console.log("Original spareparts (FROM DATABASE):", originalSpareparts);

                // PERBAIKAN: Set komponen di Tagify dan sinkronkan sparepart data
                if (editTagify) {
                    editTagify.removeAllTags();

                    // Dapatkan array komponen
                    const komponenArray = Array.isArray(data.komponen) ? data.komponen :
                        (data.komponen ? [data.komponen] : []);

                    // Tambahkan tags
                    if (komponenArray.length > 0) {
                        editTagify.addTags(komponenArray);
                    }

                    // Sinkronkan sparepart data - GUNAKAN FUNGSI YANG SUDAH DIPERBAIKI
                    setTimeout(() => {
                        syncSparepartDataWithKomponen(komponenArray, originalSpareparts);
                        syncSparepartTable();

                        // Debug
                        debugSparepartSync('INITIAL LOAD');
                    }, 300);
                }

                // Tampilkan modal
                const modal = new bootstrap.Modal(document.getElementById('editEstimasiModal'));
                modal.show();

            } catch (error) {
                console.error('Error loading estimasi for edit:', error);
                alert('Terjadi kesalahan saat memuat data estimasi: ' + error.message);
            }
        }

        // Fungsi untuk memeriksa konsistensi data sebelum menyimpan
        function validateSparepartDataBeforeSave() {
            console.log("=== VALIDASI DATA SEBELUM SIMPAN ===");
            console.log("Original Spareparts:", originalSpareparts);
            console.log("Current SparepartData:", sparepartData);

            // Periksa setiap komponen apakah nomor partnya terpertahankan
            sparepartData.forEach((item, index) => {
                const originalItem = originalSpareparts.find(orig => orig.name === item.name);
                console.log(`Komponen ${index + 1}: ${item.name}`);
                console.log(`- Nomor part saat ini: ${item.number}`);
                console.log(`- Nomor part original: ${originalItem ? originalItem.number : 'Tidak ditemukan'}`);
                console.log(`- Status: ${item.number ? '✅ ADA' : '❌ KOSONG'}`);
            });
        }

        // PERBAIKAN: Fungsi untuk mensinkronkan data sparepart dengan komponen (CASE INSENSITIVE)
        function syncSparepartDataWithKomponen(komponenArray, existingSpareparts) {
            // Normalisasi komponenArray menjadi lowercase untuk perbandingan
            const komponenNormalized = Array.isArray(komponenArray)
                ? komponenArray.map(k => k.toLowerCase().trim())
                : (komponenArray ? [komponenArray.toLowerCase().trim()] : []);

            sparepartData = [];

            komponenNormalized.forEach((namaKomponenNormalized, index) => {
                // Dapatkan nama asli dari komponenArray (dengan case asli)
                const namaKomponenAsli = Array.isArray(komponenArray)
                    ? komponenArray[index]
                    : komponenArray;

                // Cari data sparepart yang sudah ada untuk komponen ini (CASE INSENSITIVE)
                let existingData = existingSpareparts.find(item =>
                    item.name && item.name.toLowerCase().trim() === namaKomponenNormalized
                );

                if (existingData) {
                    // Gunakan data yang sudah ada
                    const transformedData = {
                        name: namaKomponenAsli, // Gunakan nama dengan case asli
                        number: existingData.number || '',
                        price: existingData.price || 0,
                        qty: existingData.qty || 1,
                        availability: existingData.availability || '',
                        total: existingData.total || existingData.subtotal || 0
                    };

                    sparepartData.push(transformedData);
                    console.log(`✅ Data ditemukan untuk ${namaKomponenAsli}:`, transformedData);
                } else {
                    // Jika tidak ada data yang cocok, buat data baru
                    sparepartData.push({
                        name: namaKomponenAsli, // Gunakan nama dengan case asli
                        number: '',
                        price: 0,
                        qty: 1,
                        availability: '',
                        total: 0
                    });
                    console.log(`🆕 Data baru untuk ${namaKomponenAsli}`);
                }
            });

            console.log("Sparepart data after sync:", sparepartData);
        }

        // PERBAIKAN: Fungsi untuk mensinkronisasi tabel sparepart dengan badge berwarna
        function syncSparepartTable() {
            const tbody = document.querySelector('#editSparepartTable tbody');
            tbody.innerHTML = '';

            // Update badge jml item
            const itemCount = sparepartData.length;
            document.getElementById('totalSparepartCount').textContent = itemCount + ' Item';

            console.log("Rendering sparepart table dengan data:", sparepartData);

            // Render baris untuk setiap komponen
            sparepartData.forEach((item, index) => {
                const availability = item.availability || '';
                const badgeClass = getAvailabilityBadgeClass(availability);
                const badgeText = getAvailabilityText(availability);

                const row = `
        <tr data-komponen="${item.name}" data-index="${index}">
            <td>${item.name || '-'}</td>
            <td>${item.number || '-'}</td>
            <td>${item.price ? formatRupiah(item.price) : 'Rp 0'}</td>
            <td>${item.qty || '1'}</td>
            <td>${item.total ? formatRupiah(item.total) : 'Rp 0'}</td>
            <td class="text-center">
                <span class="badge ${badgeClass} availability-badge" 
                      data-availability="${availability}"
                      style="cursor: default; min-width: 70px; display: inline-block;">
                    ${badgeText}
                </span>
            </td>
        </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });

            // Hitung ulang total harga
            calculateTotalHarga();
        }

        // PERBAIKAN: Fungsi untuk menghitung total harga
        function calculateTotalHarga() {
            let totalHarga = 0;

            sparepartData.forEach(item => {
                if (item.price && item.qty) {
                    totalHarga += item.price * item.qty;
                }
            });

            document.getElementById('totalHargaSparepart').textContent = formatRupiah(totalHarga);
        }

        // Fungsi utilitas untuk debugging
        function debugSparepartSync(action) {
            console.log(`=== DEBUG SPAREPART SYNC - ${action} ===`);
            console.log("Tagify values:", editTagify ? editTagify.value.map(tag => tag.value) : []);
            console.log("SparepartData:", sparepartData);
            console.log("OriginalSpareparts:", originalSpareparts);

            const tbody = document.querySelector('#editSparepartTable tbody');
            console.log("Rows in table:", tbody.children.length);
        }

        // Panggil fungsi debug di berbagai titik
        function initEditTagify() {
            const input = document.querySelector('input[name=editTags]');
            if (input && !editTagify) {
                editTagify = new Tagify(input, {
                    pattern: /^.{1,50}$/,
                    maxTags: Infinity,
                    dropdown: {
                        enabled: 0
                    },
                    duplicates: false,
                    whitelist: [],
                    // Tambahkan transform untuk konsistensi case
                    transformTag: function (tagData) {
                        // Simpan dengan case asli, tapi gunakan lowercase untuk deduplikasi
                        tagData.originalValue = tagData.value;
                        return tagData;
                    }
                });

                // ... event listeners yang sudah diperbaiki di atas ...

                // Debug
                editTagify.on('add', function (e) {
                    debugSparepartSync('ADD');
                });

                editTagify.on('remove', function (e) {
                    debugSparepartSync('REMOVE');
                });
            }
        }
        // Fungsi untuk mengecek apakah nomor rangka sudah ada di database
// Fungsi untuk mengecek apakah nomor rangka sudah ada di database master
async function checkNomorRangkaExists(nomorRangka) {
    try {
        const { data, error } = await supabaseMaster
            .from('master_kendaraan')
            .select('nopol')
            .eq('nomor_rangka', nomorRangka)
            .single();

        if (error && error.code !== 'PGRST116') throw error;

        return !!data; // return true jika ada, false jika tidak ada

    } catch (error) {
        console.error('Error checking nomor rangka:', error);
        return false;
    }
}

        // Fungsi untuk validasi nomor rangka
        function validateNomorRangka(nomorRangka) {
            // Basic validation - bisa disesuaikan dengan format nomor rangka Toyota
            return nomorRangka.length >= 10 && nomorRangka.length <= 20;
        }

        // PERBAIKAN: Inisialisasi Tagify untuk form edit dengan callback sinkronisasi yang benar
        function initEditTagify() {
            const input = document.querySelector('input[name=editTags]');
            if (input && !editTagify) {
                editTagify = new Tagify(input, {
                    pattern: /^.{1,50}$/,
                    maxTags: Infinity,
                    dropdown: {
                        enabled: 0
                    },
                    duplicates: false, // JANGAN izinkan duplikat
                    whitelist: []
                });

                // PERBAIKAN: Event listener yang benar untuk sinkronisasi (CASE INSENSITIVE)
                editTagify.on('add', function (e) {
                    const newKomponen = e.detail.data.value || e.detail.data;
                    console.log("Komponen ditambahkan:", newKomponen);

                    // Normalisasi untuk perbandingan
                    const newKomponenNormalized = newKomponen.toLowerCase().trim();

                    // Cek apakah komponen sudah ada (CASE INSENSITIVE)
                    const existingIndex = sparepartData.findIndex(item =>
                        item.name && item.name.toLowerCase().trim() === newKomponenNormalized
                    );

                    if (existingIndex === -1) {
                        // Komponen baru, tambahkan ke sparepartData
                        const newItem = {
                            name: newKomponen, // Simpan dengan case asli
                            number: '',
                            price: 0,
                            qty: 1,
                            availability: '',
                            total: 0
                        };

                        // Cari data dari originalSpareparts untuk komponen dengan nama yang sama (case insensitive)
                        const originalItem = originalSpareparts.find(item =>
                            item.name && item.name.toLowerCase().trim() === newKomponenNormalized
                        );

                        if (originalItem) {
                            // SALIN SEMUA DATA dari original
                            newItem.number = originalItem.number || '';
                            newItem.price = originalItem.price || 0;
                            newItem.qty = originalItem.qty || 1;
                            newItem.availability = originalItem.availability || '';
                            newItem.total = originalItem.total || 0;
                        }

                        sparepartData.push(newItem);
                        console.log("SparepartData setelah tambah:", sparepartData);
                    } else {
                        console.log("Komponen sudah ada:", newKomponen);
                    }

                    syncSparepartTable();
                });

                editTagify.on('remove', function (e) {
                    const removedTag = e.detail.data.value || e.detail.data;
                    console.log("Komponen dihapus:", removedTag);

                    // Normalisasi untuk pencarian
                    const removedTagNormalized = removedTag.toLowerCase().trim();

                    // Hapus dari sparepartData (CASE INSENSITIVE)
                    const index = sparepartData.findIndex(item =>
                        item.name && item.name.toLowerCase().trim() === removedTagNormalized
                    );

                    if (index >= 0) {
                        sparepartData.splice(index, 1);
                        console.log("SparepartData setelah hapus:", sparepartData);
                    } else {
                        console.log("Komponen tidak ditemukan untuk dihapus:", removedTag);
                    }

                    syncSparepartTable();
                });

                // Handle perubahan tag yang sudah ada (termasuk perubahan case)
                editTagify.on('change', function (e) {
                    console.log("Tagify change event:", e.detail);

                    // Dapatkan semua tags dengan case yang benar
                    const currentTags = editTagify.value.map(tag => tag.value);

                    // Sinkronkan ulang dengan mempertahankan data yang ada
                    syncSparepartDataWithKomponen(currentTags, originalSpareparts);
                    syncSparepartTable();
                });
            }
        }

        // PERBAIKAN TOTAL: Fungsi utama update estimasi dengan transformasi data
async function updateEstimasi(statusAction = null) {
    try {
        const id = document.getElementById('editEstimasiId').value;
        const nopol = document.getElementById('editNopol').value.trim();
        const jenisMobil = document.getElementById('editJenisMobil').value;
        const telepon = document.getElementById('editTelepon').value.trim();
        const serviceAdvisor = document.getElementById('editServiceAdvisor').value;
        const nomorRangka = document.getElementById('editNomorRangka').value.trim();
        const keterangan = document.getElementById('editKeterangan').value.trim();

        // ... (kode existing untuk validasi dan transformasi data) ...

        console.log("=== FINAL PAYLOAD KE DATABASE ===");
        console.log("Service Advisor:", serviceAdvisor);
        console.log("Status Action:", statusAction);
        console.log(JSON.stringify(payload, null, 2));

        // ✅ UPDATE MELALUI SUPABASE CLIENT (INI YANG AKAN TRIGGER REALTIME)
        const { data: updatedData, error } = await supabase
            .from('estimasi')
            .update(payload)
            .eq('id', id)
            .select(); // ✅ DAPATKAN DATA YANG BARUS DIUPDATE

        if (error) throw error;

        console.log('✅ UPDATE BERHASIL VIA SUPABASE CLIENT:', updatedData);

        // ✅ FIREBASE NOTIFICATION UNTUK SA TERTENTU
        if (statusAction === 'sent' && serviceAdvisor) {
            console.log(`🎯 MENGIRIM NOTIFIKASI FIREBASE KE: ${serviceAdvisor}`);
            
            // Trigger Firebase notification
            setTimeout(() => {
                if (window.triggerFirebaseNotification) {
                    const success = window.triggerFirebaseNotification(serviceAdvisor, nopol);
                    if (success) {
                        console.log(`✅ Firebase notification berhasil dikirim ke ${serviceAdvisor}`);
                    }
                }
            }, 1000);
        }

        // Tampilkan pesan sukses
        let message = 'Estimasi berhasil diperbarui!';
        if (newImageUrls.length > 0) {
            message += ` ${newImageUrls.length} gambar baru diupload.`;
        }
        if (statusAction === 'pending') {
            message = 'Estimasi berhasil dikirim ke bagian sparepart!';
        } else if (statusAction === 'sent') {
            message = `Estimasi berhasil dikirim ke ${serviceAdvisor}! 🚀`;
            
            // Tambahkan info notifikasi Firebase
            message += ' (Notifikasi terkirim)';
        }

        showToast('success', 'Berhasil', message);

        // Tutup modal dan reload data
        const modal = bootstrap.Modal.getInstance(document.getElementById('editEstimasiModal'));
        if (modal) modal.hide();

        await loadDashboardData();

    } catch (error) {
        console.error('Error updating estimasi:', error);
        showToast('error', 'Error', 'Terjadi kesalahan saat memperbarui estimasi: ' + error.message);
    }
}

        // FUNGSI VALIDASI BARU
        function validateSparepartData(data) {
            const errors = [];

            data.forEach((item, index) => {
                // Validasi field wajib
                if (!item.name) {
                    errors.push(`Item ${index + 1}: Nama komponen kosong`);
                }

                // Validasi field structure (pastikan sesuai format Tampermonkey)
                const requiredFields = ['name', 'number', 'price', 'availability', 'qty', 'total'];
                requiredFields.forEach(field => {
                    if (!(field in item)) {
                        errors.push(`Item ${index + 1}: Field '${field}' tidak ada`);
                    }
                });

                // Validasi tipe data
                if (typeof item.price !== 'number') {
                    errors.push(`Item ${index + 1}: Price harus number`);
                }
                if (typeof item.qty !== 'number') {
                    errors.push(`Item ${index + 1}: Qty harus number`);
                }
                if (typeof item.total !== 'number') {
                    errors.push(`Item ${index + 1}: Total harus number`);
                }
            });

            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }



        // Fungsi untuk memformat angka ke format Rupiah
        function formatRupiah(angka) {
            return 'Rp ' + new Intl.NumberFormat('id-ID').format(angka);
        }

        // Fungsi untuk mendapatkan class badge berdasarkan ketersediaan
        function getAvailabilityBadgeClass(availability) {
            switch (availability) {
                case 'ready': return 'bg-success';
                case 'tam': return 'bg-info';
                case 'bo': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        // Fungsi untuk mendapatkan teks ketersediaan
        function getAvailabilityText(availability) {
            switch (availability) {
                case 'ready': return 'Ada Stok';
                case 'tam': return 'TAM';
                case 'bo': return 'Back Order';
                default: return availability;
            }
        }

        // Format nomor polisi (uppercase dan hilangkan spasi)
        function formatNopol(input) {
            const originalValue = input.value;
            input.value = input.value.toUpperCase().replace(/\s/g, '');

            // Jika nilai berubah, trigger search
            if (originalValue !== input.value && input.value.length >= 3) {
                setTimeout(() => {
                    handleNopolChange(input.value);
                }, 300);
            }
        }

        // Fungsi async terpisah untuk menangani perubahan nopol
        async function handleNopolChange(nopol) {
            const suggestions = await searchKendaraanByNopol(nopol);
            if (suggestions.length === 1) {
                autoFillIfSingleResult(nopol);
            } else {
                showSuggestions(suggestions);
            }
        }
        // Inisialisasi Tagify
        function initTagify() {
            const input = document.querySelector('input[name=tags]');
            if (input) {
                tagify = new Tagify(input, {
                    pattern: /^.{1,50}$/,
                    maxTags: Infinity,
                    dropdown: {
                        enabled: 0
                    }
                });
            }
        }

        // Inisialisasi image upload
        function initImageUpload() {
            const addImageBtn = document.getElementById('addImageBtn');
            const fileInput = document.getElementById('fotoEstimasi');
            const imageContainer = document.getElementById('imageUploadContainer');

            // Handle click pada tombol tambah gambar
            addImageBtn.addEventListener('click', () => {
                fileInput.click();
            });

            // Handle perubahan file input
            fileInput.addEventListener('change', async (e) => {
                const files = e.target.files;
                if (!files || files.length === 0) return;

                // Batasi maksimal 5 gambar
                if (selectedImages.length + files.length > 5) {
                    //alert('Maksimal 5 gambar yang dapat diupload');
                    return;
                }

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];

                    // Kompres gambar sebelum ditambahkan
                    const compressedFile = await compressImage(file);

                    // Tambahkan ke array selectedImages
                    selectedImages.push(compressedFile);

                    // Buat preview gambar
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imagePreviewContainer = document.createElement('div');
                        imagePreviewContainer.className = 'image-preview-container';

                        const imagePreview = document.createElement('img');
                        imagePreview.src = e.target.result;
                        imagePreview.className = 'image-preview';

                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-image-btn';
                        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                        removeBtn.onclick = () => {
                            // Hapus gambar dari array dan DOM
                            const index = selectedImages.findIndex(img => img.name === file.name);
                            if (index !== -1) {
                                selectedImages.splice(index, 1);
                            }
                            imagePreviewContainer.remove();
                        };

                        imagePreviewContainer.appendChild(imagePreview);
                        imagePreviewContainer.appendChild(removeBtn);
                        imageContainer.insertBefore(imagePreviewContainer, addImageBtn);
                    };
                    reader.readAsDataURL(compressedFile);
                }

                // Reset file input
                fileInput.value = '';
            });
        }

        // Kompres gambar
        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 600;

                        let width = img.width;
                        let height = img.height;

                        // Hitung ulang ukuran jika perlu
                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Konversi ke blob dengan kualitas 70%
                        canvas.toBlob(
                            (blob) => {
                                resolve(new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                }));
                            },
                            'image/jpeg',
                            0.7
                        );
                    };
                };
            });
        }

        // Buat profil user jika belum ada
        async function createUserProfile(user) {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .insert([
                        {
                            id: user.id,
                            email: user.email,
                            role: 'teknisi'
                        }
                    ])
                    .select()
                    .single();

                if (error) throw error;

                userProfile = data;
                document.getElementById('profileRole').value = data.role;

            } catch (error) {
                console.error('Error creating user profile:', error);
                //alert('Terjadi kesalahan saat membuat profil: ' + error.message);
            }
        }

        // Load data dashboard
        async function loadDashboardData() {
            try {
                if (!currentUser) return;

                // Pastikan user profile sudah ada
                if (!userProfile) {
                    const { data: userData, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', currentUser.id)
                        .single();

                    if (error) throw error;
                    userProfile = userData;
                }

                // Hitung total estimasi
                const { count: totalCount, error: totalError } = await supabase
                    .from('estimasi')
                    .select('*', { count: 'exact', head: true })
                    .eq('teknisi_id', currentUser.id);

                if (!totalError) {
                    document.getElementById('totalEstimasi').textContent = totalCount || 0;
                }

                // Hitung estimasi dalam progress
                const { count: progressCount, error: progressError } = await supabase
                    .from('estimasi')
                    .select('*', { count: 'exact', head: true })
                    .eq('teknisi_id', currentUser.id)
                    .eq('status', 'progress');

                if (!progressError) {
                    document.getElementById('estimasiProgress').textContent = progressCount || 0;
                }

                // Hitung estimasi selesai
                const { count: completedCount, error: completedError } = await supabase
                    .from('estimasi')
                    .select('*', { count: 'exact', head: true })
                    .eq('teknisi_id', currentUser.id)
                    .eq('status', 'completed');

                if (!completedError) {
                    document.getElementById('estimasiSelesai').textContent = completedCount || 0;
                }

                // Ganti bagian loadDashboardData() - Hitung jml terkirim ke SA
                const { count: sentCount, error: sentError } = await supabase
                    .from('estimasi')
                    .select('*', { count: 'exact', head: true })
                    .eq('teknisi_id', currentUser.id)
                    .eq('status', 'sent');

                if (!sentError) {
                    document.getElementById('totalMobil').textContent = sentCount || 0;
                }

                // Load estimasi terbaru
                await loadRecentEstimasi();

                // Load semua estimasi
                await loadAllEstimasi();

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Fungsi untuk mendapatkan class badge status
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'pending': return 'status-pending';     // kuning
                case 'progress': return 'status-progress';   // biru muda
                case 'sent': return 'status-sent';           // biru kehijauan
                case 'completed': return 'status-completed'; // hijau
                case 'waiting': return 'status-waiting';     // merah muda
                case 'done': return 'status-done';           // abu-abu
                default: return 'status-secondary';          // default abu
            }
        }


        // Load estimasi terbaru
        async function loadRecentEstimasi() {
        document.querySelector('#recentEstimasi').innerHTML = '';

            try {
                if (!currentUser) return;

                const { data, error } = await supabase
                    .from('estimasi')
                    .select('*')
                    .eq('teknisi_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                const tbody = document.getElementById('recentEstimasi');
                tbody.innerHTML = '';

                if (data && data.length > 0) {
                    // 🔹 Panggil waktu server sekali saja di awal
                    const { data: serverTimeData, error: timeError } = await supabase.rpc('get_server_time');
                    if (timeError) {
                        console.error("Gagal ambil waktu server:", timeError);
                        return;
                    }
                    const serverTime = new Date(serverTimeData);
                    console.log("🕓 Waktu server Supabase:", serverTime.toLocaleString('id-ID'));

                    for (let index = 0; index < data.length; index++) {
                        const estimasi = data[index];
                        const row = document.createElement('tr');

                        const jenisMobilText = estimasi.jenis_mobil
                            ? (estimasi.jenis_mobil.length > 10
                                ? estimasi.jenis_mobil.substring(0, 10) + '...'
                                : estimasi.jenis_mobil)
                            : '-';

                        // === Logika kunci edit berdasarkan waktu server ===
                        const createdAt = new Date(estimasi.created_at);

                        // Hitung selisih jam antara waktu server dan waktu dibuat
                        const diffHours = (serverTime - createdAt) / (1000 * 60 * 60);

                        // 🔹 Hanya dikunci jika sudah lebih dari 24 jam
                        const isExpired = diffHours >= 24;

                        // Tambahkan log biar bisa dipantau
                        console.log(
                            `📄 Estimasi ID: ${estimasi.id} | Created: ${createdAt.toLocaleString('id-ID')} | Selisih: ${diffHours.toFixed(2)} jam | ${isExpired ? '🔒 LOCKED' : '✅ UNLOCKED'}`
                        );

                        row.innerHTML = `
        <td>${index + 1}</td>
        <td>${estimasi.nopol || '-'}</td>
        <td><span class="truncate-text" title="${estimasi.jenis_mobil || '-'}">${jenisMobilText}</span></td>
        <td>${estimasi.created_at ? new Date(estimasi.created_at).toLocaleDateString('id-ID') : '-'}</td>
        <td><span class="status-badge status-${estimasi.status}">${getStatusText(estimasi.status)}</span></td>
        <td>
          <div class="action-buttons">
            <!-- Tombol Lihat selalu aktif -->
            <button class="btn btn-sm btn-outline-primary view-estimasi" data-id="${estimasi.id}" title="Lihat">
              <i class="fas fa-eye"></i>
            </button>

            ${!isExpired
                                ? `
        <button class="btn btn-sm btn-outline-warning edit-estimasi" data-id="${estimasi.id}" title="Edit">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-outline-danger delete-estimasi" data-id="${estimasi.id}" title="Hapus">
          <i class="fas fa-trash"></i>
        </button>
      `
                                : `
        <button class="btn btn-sm btn-outline-secondary disabled-action" disabled title="Terkunci (lebih dari 1 hari)">
          <i class="fas fa-lock"></i>
        </button>
        <button class="btn btn-sm btn-outline-secondary disabled-action" disabled title="Terkunci (lebih dari 1 hari)">
          <i class="fas fa-lock"></i>
        </button>
      `
                            }

        </td>
    `;

                        tbody.appendChild(row);
                    }

                } else {
                    // jml kolom ada 6, jadi colspan harus 6
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Tidak ada data estimasi</td></tr>';
                }

                // Event listener tombol view
                document.querySelectorAll('.view-estimasi').forEach(button => {
                    button.addEventListener('click', function () {
                        const estimasiId = this.getAttribute('data-id');
                        viewEstimasi(estimasiId);
                    });
                });

                // Event listener tombol edit
                document.querySelectorAll('.edit-estimasi').forEach(button => {
                    button.addEventListener('click', function () {
                        const estimasiId = this.getAttribute('data-id');
                        openEditEstimasi(estimasiId);
                    });
                });

                // Event listener tombol delete
                document.querySelectorAll('.delete-estimasi').forEach(button => {
                    button.addEventListener('click', function () {
                        const estimasiId = this.getAttribute('data-id');
                        deleteEstimasi(estimasiId);
                    });
                });

                // Hanya pasang event listener kalau tombol ada
                const btnLihatSemua = document.querySelector('[data-section="estimasi-saya2"]');
                if (btnLihatSemua) {
                    btnLihatSemua.addEventListener('click', function (e) {
                        e.preventDefault();
                        $('.sidebar-menu a').removeClass('active');
                        $(this).addClass('active');
                        $('.content-section').removeClass('active');
                        $('#estimasi-saya').addClass('active');
                        $('#pageTitle').text('Estimasi Saya');
                        $('#mobileTitle').text('Estimasi Saya');
                    });
                }

            } catch (error) {
                console.error('Error loading recent estimasi:', error);
            }
        }

        async function sendToSA(id) {
            if (!confirm("Apakah Anda yakin ingin mengirim estimasi ini ke SA?")) return;

            try {
                const { error } = await supabase
                    .from('estimasi')
                    .update({
                        status: 'sent',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', id);

                if (error) throw error;

                //alert("Estimasi berhasil dikirim ke SA!");
                await loadRecentEstimasi();

            } catch (err) {
                console.error(err);
                //alert("Gagal mengirim estimasi: " + err.message);
            }
        }


        // Load semua estimasi
        // Ganti fungsi loadAllEstimasi dengan ini
        async function loadAllEstimasi(searchTerm = '') {
            try {
                if (!currentUser) return;

                let query = supabase
                    .from('estimasi')
                    .select('*')
                    .eq('teknisi_id', currentUser.id)
                    .order('created_at', { ascending: false });

                // Tambahkan filter pencarian jika ada
                if (searchTerm) {
                    query = query.ilike('nopol', `%${searchTerm}%`);
                }

                const { data, error } = await query;

                if (error) throw error;

                const tbody = document.getElementById('estimasiList');
                tbody.innerHTML = '';

                if (data && data.length > 0) {
                    data.forEach((estimasi, index) => {
                        const row = document.createElement('tr');

                        // Format teks untuk tampilan mobile
                        const jenisMobilText = estimasi.jenis_mobil.length > 10 ?
                            estimasi.jenis_mobil.substring(0, 10) + '...' : estimasi.jenis_mobil;

                        const komponenText = Array.isArray(estimasi.komponen) ?
                            (estimasi.komponen.join(', ').length > 10 ?
                                estimasi.komponen.join(', ').substring(0, 10) + '...' :
                                estimasi.komponen.join(', ')) :
                            (estimasi.komponen.length > 10 ?
                                estimasi.komponen.substring(0, 10) + '...' :
                                estimasi.komponen);

                        row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${estimasi.nopol}</td>
                    <td><span class="truncate-text" title="${estimasi.jenis_mobil}">${jenisMobilText}</span></td>
                    <td><span class="truncate-text" title="${Array.isArray(estimasi.komponen) ? estimasi.komponen.join(', ') : estimasi.komponen}">${komponenText}</span></td>
                    <td>${new Date(estimasi.created_at).toLocaleDateString('id-ID')}</td>
                    <td><span class="status-badge status-${estimasi.status}">${getStatusText(estimasi.status)}</span></td>
                    <td>
  <div class="action-buttons">
    <!-- Tombol Lihat selalu aktif -->
    <button class="btn btn-sm btn-outline-primary view-estimasi" data-id="${estimasi.id}" title="Lihat">
      <i class="fas fa-eye"></i>
    </button>

    <!-- Tombol Edit & Hapus hanya aktif di pending & progress -->
    ${['pending', 'progress'].includes(estimasi.status)
                                ? `
        <button class="btn btn-sm btn-outline-warning edit-estimasi" data-id="${estimasi.id}" title="Edit">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-outline-danger delete-estimasi" data-id="${estimasi.id}" title="Hapus">
          <i class="fas fa-trash"></i>
        </button>
      `
                                : `
        <button class="btn btn-sm btn-outline-secondary disabled-action" disabled title="Tidak dapat diubah">
          <i class="fas fa-lock"></i>
        </button>
        <button class="btn btn-sm btn-outline-secondary disabled-action" disabled title="Tidak dapat dihapus">
          <i class="fas fa-lock"></i>
        </button>
      `
                            }
  </div>
</td>

                `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Tidak ada data estimasi</td></tr>';
                }

                // Tambahkan event listener untuk tombol
                addEstimasiEventListeners();

            } catch (error) {
                console.error('Error loading all estimasi:', error);
            }
        }

        // Fungsi untuk menambahkan event listener
        function addEstimasiEventListeners() {
            document.querySelectorAll('.view-estimasi').forEach(button => {
                button.addEventListener('click', function () {
                    const estimasiId = this.getAttribute('data-id');
                    viewEstimasi(estimasiId);
                });
            });

            document.querySelectorAll('.edit-estimasi').forEach(button => {
                button.addEventListener('click', function () {
                    const estimasiId = this.getAttribute('data-id');
                    openEditEstimasi(estimasiId);
                });
            });

            document.querySelectorAll('.delete-estimasi').forEach(button => {
                button.addEventListener('click', function () {
                    const estimasiId = this.getAttribute('data-id');
                    deleteEstimasi(estimasiId);
                });
            });
        }

        // Fungsi untuk mendapatkan teks status
        function getStatusText(status) {
            switch (status) {
                case 'pending': return 'Pending';
                case 'progress': return 'ReCheck Part';
                case 'completed': return 'Complete';
                case 'done': return 'Done';
                case 'waiting': return 'Waiting MRA';
                case 'sent': return 'Waiting SA';
                default: return status;
            }
        }
        // Fungsi untuk membuka modal detail estimasi
        async function viewEstimasi(id) {
            try {
                const { data, error } = await supabase
                    .from('estimasi')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                currentEstimasiId = id;

                // Isi data ke modal detail
                document.getElementById('detailNopol').value = data.nopol || '';
                document.getElementById('detailJenisMobil').value = data.jenis_mobil || '';
                document.getElementById('detailTelepon').value = data.telepon_customer || '';
                document.getElementById('detailServiceAdvisor').value = data.service_advisor || '';
                document.getElementById('detailNomorRangka').value = data.nomor_rangka || '';
                document.getElementById('detailKeterangan').value = data.keterangan || '';

                // Tampilkan komponen dengan jml
                const komponenList = document.getElementById('detailKomponenList');
                komponenList.innerHTML = '';

                const komponenArray = Array.isArray(data.komponen) ? data.komponen :
                    (data.komponen ? [data.komponen] : []);

                // PERBAIKAN: Update jml komponen
                document.getElementById('detailKomponenCount').textContent = komponenArray.length + ' Komponen';

                komponenArray.forEach(komponen => {
                    const badge = document.createElement('span');
                    badge.className = 'komponen-badge';
                    badge.textContent = komponen;
                    komponenList.appendChild(badge);
                });

                // Handle sparepart data
                let sparepartArray = [];
                if (data.sparepart_data) {
                    if (Array.isArray(data.sparepart_data)) {
                        sparepartArray = data.sparepart_data;
                    } else if (typeof data.sparepart_data === 'string') {
                        try {
                            sparepartArray = JSON.parse(data.sparepart_data);
                            if (!Array.isArray(sparepartArray)) sparepartArray = [];
                        } catch (e) {
                            sparepartArray = [];
                        }
                    }
                }

                // Isi tabel sparepart
                const tbody = document.querySelector('#detailSparepartTable tbody');
                tbody.innerHTML = '';

                // PERBAIKAN: Update badge jml item
                document.getElementById('detailTotalSparepartCount').textContent = sparepartArray.length + ' Item';

                let totalHarga = 0;

                sparepartArray.forEach((item) => {
                    const subtotal = (item.price || 0) * (item.qty || 1);
                    totalHarga += subtotal;

                    const row = `
                <tr>
                    <td>${item.name || '-'}</td>
                    <td>${item.price ? formatRupiah(item.price) : '0'}</td>
                    <td>${item.qty || '-'}</td>
                    <td>${item.total ? formatRupiah(item.total) : '0'}</td>
                    <td>
                        ${item.availability ?
                            `<span class="badge ${getAvailabilityBadgeClass(item.availability)}">
                             ${getAvailabilityText(item.availability)}
                             </span>` :
                            '-'
                        }
                    </td>                    
                </tr>`;
                    tbody.insertAdjacentHTML('beforeend', row);
                });

                // Update total harga
                document.getElementById('detailTotalHargaSparepart').textContent = formatRupiah(totalHarga);

                // Handle foto dengan jml
                const fotoContainer = document.getElementById('detailFotoContainer');
                fotoContainer.innerHTML = '';

                let fotoUrls = [];
                if (data.foto_url) {
                    if (Array.isArray(data.foto_url)) {
                        fotoUrls = data.foto_url;
                    } else if (typeof data.foto_url === 'string') {
                        try {
                            fotoUrls = JSON.parse(data.foto_url);
                            if (!Array.isArray(fotoUrls)) fotoUrls = [data.foto_url];
                        } catch (e) {
                            fotoUrls = [data.foto_url];
                        }
                    }
                }

                // PERBAIKAN: Update jml foto
                document.getElementById('detailFotoCount').textContent = fotoUrls.length + ' Foto';

                if (fotoUrls.length > 0) {
                    fotoUrls.forEach(url => {
                        const imagePreviewContainer = document.createElement('div');
                        imagePreviewContainer.className = 'image-preview-container';

                        const imagePreview = document.createElement('img');
                        imagePreview.src = url;
                        imagePreview.className = 'image-preview';
                        imagePreview.style.cursor = 'pointer';

                        // Tambahkan event click untuk memperbesar gambar
                        imagePreview.onclick = () => {
                            window.open(url, '_blank');
                        };

                        imagePreviewContainer.appendChild(imagePreview);
                        fotoContainer.appendChild(imagePreviewContainer);
                    });
                } else {
                    fotoContainer.innerHTML = '<p class="text-muted">Tidak ada foto</p>';
                }

                // Update status badge
                const statusBadge = document.getElementById('detailStatusBadge');
                statusBadge.textContent = getStatusText(data.status);
                statusBadge.className = `badge ${getStatusBadgeClass(data.status)}`;

                // Event listener untuk tombol cetak
                document.getElementById('detailPrintA4').onclick = () => generatePdf('a4');
                document.getElementById('detailPrintA5').onclick = () => generatePdfA5('a6');

                // PERBAIKAN: Auto-expand di desktop, collapse di mobile
                setTimeout(() => {
                    if (window.innerWidth >= 769) {
                        // Auto expand di desktop
                        const infoCollapse = document.getElementById('detailInfoKendaraanCollapse');
                        const keteranganCollapse = document.getElementById('detailKeteranganCollapse');

                        if (infoCollapse) {
                            const bsCollapse = new bootstrap.Collapse(infoCollapse, { toggle: false });
                            bsCollapse.show();
                        }
                        if (keteranganCollapse) {
                            const bsCollapse = new bootstrap.Collapse(keteranganCollapse, { toggle: false });
                            bsCollapse.show();
                        }
                    }
                }, 100);

                // Tampilkan modal
                const modal = new bootstrap.Modal(document.getElementById('detailEstimasiModal'));
                modal.show();

            } catch (error) {
                console.error('Error loading estimasi detail:', error);
                showToast('error', 'Error', 'Terjadi kesalahan saat memuat detail estimasi: ' + error.message);
            }
        }

        // PERBAIKAN: Event listener untuk modal detail
        document.addEventListener('DOMContentLoaded', function () {
            // Fix untuk modal backdrop
            const detailModal = document.getElementById('detailEstimasiModal');
            if (detailModal) {
                detailModal.addEventListener('hidden.bs.modal', function () {
                    // Hapus backdrop dengan benar
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => {
                        backdrop.remove();
                    });

                    // Reset body styles
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = 'auto';
                    document.body.style.paddingRight = '0px';
                });

                detailModal.addEventListener('show.bs.modal', function () {
                    // Pastikan hanya satu backdrop
                    const existingBackdrops = document.querySelectorAll('.modal-backdrop');
                    existingBackdrops.forEach(backdrop => {
                        backdrop.remove();
                    });
                });
            }
        });

        // Fungsi untuk mendapatkan class badge status
        function getStatusText(status) {
            switch (status) {
                case 'pending': return 'Waiting Part'; // ubah teks
                case 'progress': return 'ReCheck';
                case 'sent': return 'Waiting SA';
                case 'completed': return 'Completed';
                case 'waiting': return 'Waiting MRA';
                case 'done': return 'Done';
                default: return status;
            }
        }



        // Fungsi untuk mengirim estimasi ke Service Advisor
        async function sendToServiceAdvisor() {
            try {
                const id = document.getElementById('editEstimasiId').value;

                // Ambil data estimasi
                const { data: estimasi, error: fetchError } = await supabase
                    .from('estimasi')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (fetchError) throw fetchError;

                // Salin data ke tabel service_advisor
                const { error: insertError } = await supabase
                    .from('service_advisor')
                    .insert([
                        {
                            estimasi_id: estimasi.id,
                            nopol: estimasi.nopol,
                            jenis_mobil: estimasi.jenis_mobil,
                            telepon_customer: estimasi.telepon_customer,
                            service_advisor: estimasi.service_advisor,
                            komponen: estimasi.komponen,
                            keterangan: estimasi.keterangan,
                            status: 'dikirim',
                            teknisi_id: currentUser.id,
                            created_at: new Date().toISOString()
                        }
                    ]);

                if (insertError) throw insertError;

                // Update status estimasi
                const { error: updateError } = await supabase
                    .from('estimasi')
                    .update({
                        status: 'sent',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', id);

                if (updateError) throw updateError;

                //alert('Estimasi berhasil dikirim ke Service Advisor!');

                // Tutup modal dan reload data
                bootstrap.Modal.getInstance(document.getElementById('editEstimasiModal')).hide();
                await loadDashboardData();

            } catch (error) {
                console.error('Error sending to service advisor:', error);
                //alert('Terjadi kesalahan saat mengirim ke Service Advisor: ' + error.message);
            }
        }

        // Hapus estimasi
       async function deleteEstimasi(id) {
    if (!confirm('Yakin ingin menghapus estimasi ini?')) return;

    const { error } = await supabase.from('estimasi').delete().eq('id', id);
    if (error) {
        alert('Gagal menghapus estimasi!');
        return;
    }

    await loadRecentEstimasi(); // ✅ panggil ulang fungsi setelah delete
}

// Cetak PDF dengan format tertentu
async function generatePdf(format = 'a4') {
    try {
        const { data: estimasiData, error: estimasiError } = await supabase
            .from('estimasi')
            .select('*')
            .eq('id', currentEstimasiId)
            .single();

        if (estimasiError) throw estimasiError;

        // Ambil data teknisi
        let teknisiNama = '-';
        if (estimasiData.teknisi_id) {
            const { data: userData, error: userError } = await supabase
                .from('users')
                .select('full_name')
                .eq('id', estimasiData.teknisi_id)
                .single();
            
            if (!userError && userData) {
                teknisiNama = userData.full_name;
            }
        }

        // Handle foto_url yang bisa berupa string atau array
        let fotoUrls = [];
        if (estimasiData.foto_url) {
            if (Array.isArray(estimasiData.foto_url)) {
                fotoUrls = estimasiData.foto_url;
            } else if (typeof estimasiData.foto_url === 'string') {
                try {
                    fotoUrls = JSON.parse(estimasiData.foto_url);
                    if (!Array.isArray(fotoUrls)) {
                        fotoUrls = [estimasiData.foto_url];
                    }
                } catch (e) {
                    fotoUrls = [estimasiData.foto_url];
                }
            }
        }

        let sparepartData = [];
        if (estimasiData.sparepart_data) {
            if (Array.isArray(estimasiData.sparepart_data)) {
                sparepartData = estimasiData.sparepart_data;
            } else if (typeof estimasiData.sparepart_data === 'string') {
                try {
                    sparepartData = JSON.parse(estimasiData.sparepart_data);
                    if (!Array.isArray(sparepartData)) {
                        sparepartData = [];
                    }
                } catch (e) {
                    sparepartData = [];
                }
            }
        }

        // Format komponen menjadi string dengan koma
        let komponenText = '-';
        if (estimasiData.komponen) {
            if (Array.isArray(estimasiData.komponen)) {
                komponenText = estimasiData.komponen.join(', ');
            } else {
                komponenText = estimasiData.komponen;
            }
        }

        // Hitung total harga manual dari sparepart_data
        let totalHargaManual = 0;
        if (sparepartData.length > 0) {
            totalHargaManual = sparepartData.reduce((total, item) => {
                return total + (parseFloat(item.total) || 0);
            }, 0);
        }

        // Buat konten PDF yang lebih compact
        const pdfContent = `
        <div style="font-family: Arial, sans-serif; padding: 15px; font-size: 12px;">
            <div style="text-align: center; margin-bottom: 15px;">
                <h2 style="color: #e60000; margin-bottom: 3px; font-size: 18px;">Tunas Toyota Batutulis</h2>
                <p style="margin: 0; font-size: 11px;">Jl. Batutulis No. 42,RT.7/RW.2 Jakarta Pusat</p>
                <p style="margin: 0; font-size: 11px;">Telp: (021) 3454465</p>
                <hr style="border-top: 2px solid #e60000; margin: 10px 0;">
                <h3 style="margin-bottom: 15px; font-size: 16px;">Estimasi Perbaikan Kendaraan</h3>
            </div>
            
            <!-- Info Customer Compact -->
            <div style="margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 3px 5px; width: 30%;"><strong>Nomor Polisi:</strong></td>
                        <td style="padding: 3px 5px;">${estimasiData.nopol}</td>
                        <td style="padding: 3px 5px; width: 30%;"><strong>Tanggal Estimasi:</strong></td>
                        <td style="padding: 3px 5px;">${new Date(estimasiData.created_at).toLocaleDateString('id-ID')}</td>
                    </tr>
                    <tr>
                        <td style="padding: 3px 5px;"><strong>Jenis Mobil:</strong></td>
                        <td style="padding: 3px 5px;">${estimasiData.jenis_mobil}</td>
                        <td style="padding: 3px 5px;"><strong>Nama Teknisi:</strong></td>
                        <td style="padding: 3px 5px;">${teknisiNama}</td>
                    </tr>
                    <tr>
                        <td style="padding: 3px 5px;"><strong>Nomor Rangka:</strong></td>
                        <td style="padding: 3px 5px;">${estimasiData.nomor_rangka || '-'}</td>
                        <td style="padding: 3px 5px;"><strong>Service Advisor:</strong></td>
                        <td style="padding: 3px 5px;">${estimasiData.service_advisor || '-'}</td>
                    </tr>
                </table>
            </div>
            
            <!-- Komponen yang Perlu Diperbaiki -->
            <div style="margin-bottom: 15px;">
                <p style="margin: 0 0 5px 0; font-weight: bold;">Komponen yang Perlu Diperbaiki/Diganti:</p>
                <div style="background: #fff; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    ${komponenText}
                </div>
            </div>
            
            ${sparepartData.length > 0 ? `
            <!-- Tabel Sparepart -->
            <div style="margin-bottom: 15px;">
                <p style="margin: 0 0 5px 0; font-weight: bold;">Detail Sparepart:</p>
                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                    <thead>
                        <tr>
                            <th style="background-color: #e60000; color: white; padding: 6px; text-align: left; border: 1px solid #ddd;">Nama Komponen</th>
                            <th style="background-color: #e60000; color: white; padding: 6px; text-align: center; border: 1px solid #ddd; width: 15%;">Harga Satuan</th>
                            <th style="background-color: #e60000; color: white; padding: 6px; text-align: center; border: 1px solid #ddd; width: 10%;">Jumlah</th>
                            <th style="background-color: #e60000; color: white; padding: 6px; text-align: center; border: 1px solid #ddd; width: 15%;">Ketersediaan</th>
                            <th style="background-color: #e60000; color: white; padding: 6px; text-align: center; border: 1px solid #ddd; width: 15%;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sparepartData.map(item => `
                            <tr>
                                <td style="padding: 6px; border: 1px solid #ddd;">${item.name || '-'}</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${formatRupiah(item.price || 0)}</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${item.qty || 1}</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${item.availability || '-'}</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${formatRupiah(item.total || 0)}</td>
                            </tr>
                        `).join('')}
                        <tr style="font-weight: bold; background-color: #f2f2f2;">
                            <td colspan="4" style="padding: 8px; border: 1px solid #ddd; text-align: right;">Total Harga Final:</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${formatRupiah(totalHargaManual)}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            ` : ''}
            
            <!-- Keterangan -->
            <div style="margin-bottom: 15px;">
                <p style="margin: 0 0 5px 0; font-weight: bold;">Keterangan:</p>
                <div style="background: #fff; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    ${estimasiData.keterangan || 'Tidak ada keterangan tambahan'}
                </div>
            </div>
            
            ${fotoUrls.length > 0 ? `
            <!-- Foto Komponen Bermasalah -->
            <div style="margin-bottom: 15px;">
                <p style="margin: 0 0 5px 0; font-weight: bold;">Foto Komponen Bermasalah:</p>
                <div style="display: flex; flex-wrap: wrap; gap: 5px; justify-content: flex-start;">
                    ${fotoUrls.map(url => `
                        <img src="${url}" 
                             style="max-width: 120px; max-height: 90px; object-fit: cover; border-radius: 3px; border: 1px solid #ddd; flex-shrink: 0;">
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <!-- Kontak Info -->
            <div style="background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 20px; font-size: 11px;">
                <p style="margin: 0 0 5px 0; font-weight: bold;">Untuk melakukan perbaikan komponen tersebut, hubungi:</p>
                <p style="margin: 0;">
                    <strong>Admin Tunas Toyota Batutulis</strong><br>
                    <span style="color: #25D366;">
                        <i class="fab fa-whatsapp"></i> 081315389866
                    </span>
                </p>
            </div>
            
            <!-- Footer -->
            <div style="margin-top: 20px; text-align: center; font-size: 10px; color: #6c757d;">
                <p>Dicetak pada: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}</p>
            </div>
        </div>
        `;

        // Buat elemen sementara untuk konten PDF
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = pdfContent;

        // Opsi untuk html2pdf berdasarkan format
        const opt = {
            margin: 8,
            filename: `estimasi_${estimasiData.nopol}_${new Date().getTime()}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: {
                scale: format === 'a4' ? 2 : 1.5,
                useCORS: true,
                allowTaint: true
            },
            jsPDF: {
                unit: 'mm',
                format: format,
                orientation: 'portrait'
            }
        };

        // Generate PDF
        html2pdf().set(opt).from(tempDiv).save().then(() => {
            showToast('success', 'PDF Berhasil', `File estimasi format ${format.toUpperCase()} berhasil diunduh!`);
        });

    } catch (error) {
        console.error('Error generating PDF:', error);
        showToast('error', 'Error', 'Terjadi kesalahan saat membuat PDF: ' + error.message);
    }
}

// Fungsi format Rupiah (pastikan sudah ada)
function formatRupiah(angka) {
    if (!angka) return 'Rp 0';
    return 'Rp ' + parseInt(angka).toLocaleString('id-ID');
}

        // Cetak PDF dengan format A6
        async function getBase64FromUrl(url) {
            const response = await fetch(url);
            const blob = await response.blob();
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // Helper untuk memotong string
        function truncateText(text, maxLength = 20) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '..' : text;
        }
async function generatePdfA5(format = 'A5') {
    try {
        const { data, error } = await supabase
            .from('estimasi')
            .select('*')
            .eq('id', currentEstimasiId)
            .single();

        if (error) throw error;

        // Ambil data teknisi
        let teknisiNama = '-';
        if (data.teknisi_id) {
            const { data: userData, error: userError } = await supabase
                .from('users')
                .select('full_name')
                .eq('id', data.teknisi_id)
                .single();
            
            if (!userError && userData) {
                teknisiNama = userData.full_name || '-';
            }
        }

        // Handle sparepart
        let sparepartData = [];
        let totalHargaSparepart = 0;
        if (data.sparepart_data) {
            if (Array.isArray(data.sparepart_data)) {
                sparepartData = data.sparepart_data;
            } else if (typeof data.sparepart_data === 'string') {
                try {
                    sparepartData = JSON.parse(data.sparepart_data);
                    if (!Array.isArray(sparepartData)) sparepartData = [];
                } catch (e) {
                    sparepartData = [];
                }
            }
            
            // Hitung total harga sparepart
            if (sparepartData.length > 0) {
                totalHargaSparepart = sparepartData.reduce((total, item) => {
                    const itemTotal = parseFloat(item.total || item.subtotal || 0);
                    return total + itemTotal;
                }, 0);
            }
        }

        // Handle service data
        let serviceData = [];
        let totalHargaService = 0;
        if (data.service_data) {
            if (Array.isArray(data.service_data)) {
                serviceData = data.service_data;
            } else if (typeof data.service_data === 'string') {
                try {
                    serviceData = JSON.parse(data.service_data);
                    if (!Array.isArray(serviceData)) serviceData = [];
                } catch (e) {
                    serviceData = [];
                }
            }
            
            // Hitung total harga service
            if (serviceData.length > 0) {
                totalHargaService = serviceData.reduce((total, service) => {
                    const serviceTotal = parseFloat(service.total || service.subtotal || 0);
                    return total + serviceTotal;
                }, 0);
            }
        }

        // Hitung total harga keseluruhan
        const totalHargaKeseluruhan = totalHargaSparepart + totalHargaService;

        // Handle foto URL
        let fotoArray = [];
        let fotoImages = [];
        if (data.foto_url) {
            try {
                fotoArray = typeof data.foto_url === 'string' 
                    ? JSON.parse(data.foto_url) 
                    : data.foto_url;
                
                if (!Array.isArray(fotoArray)) {
                    fotoArray = [];
                }

                // Convert foto URLs ke base64 untuk PDF
                if (fotoArray.length > 0) {
                    for (const fotoUrl of fotoArray) {
                        try {
                            const base64Image = await getBase64FromUrl(fotoUrl);
                            fotoImages.push(base64Image);
                        } catch (error) {
                            console.error('Error converting image to base64:', error);
                        }
                    }
                }
            } catch (e) {
                console.error('Error parsing foto_url:', e);
                fotoArray = [];
            }
        }

        // QR admin
        const qrBase64 = await getBase64FromUrl(
            "https://pjawwektzazcxakgopou.supabase.co/storage/v1/object/public/static/qrcode.png"
        );

        const whatsappIcon = await getBase64FromUrl(
            "https://pjawwektzazcxakgopou.supabase.co/storage/v1/object/public/static/whatsapp.png"
        );

        const tunasLogo = await getBase64FromUrl(
            "https://pjawwektzazcxakgopou.supabase.co/storage/v1/object/public/static/tunas.png"
        );

        // Siapkan content PDF
        const content = [
            { text: 'Estimasi Saran Perbaikan', alignment: 'center', fontSize: 12, margin: [0, 0, 0, 12] },

            { text: `Nomor Polisi: ${data.nopol}`, fontSize: 10, margin: [0, 0, 0, 3] },
            { text: `Nomor Rangka: ${data.nomor_rangka || '-'}`, fontSize: 10, margin: [0, 0, 0, 3] },
            { text: `Nama Teknisi: ${teknisiNama}`, fontSize: 10, margin: [0, 0, 0, 3] },
            { text: `Tanggal Estimasi: ${new Date(data.created_at).toLocaleDateString('id-ID')}`, fontSize: 10, margin: [0, 0, 0, 12] }
        ];

        // Tambahkan tabel sparepart jika ada data
        if (sparepartData.length > 0) {
            content.push({
                table: {
                    widths: ['*', 'auto', 'auto', 'auto', 'auto'],
                    body: [
                        [
                            { text: 'Nama Barang', fillColor: '#e60000', color: 'white', bold: true },
                            { text: 'Harga', fillColor: '#e60000', color: 'white', bold: true },
                            { text: 'Jml', fillColor: '#e60000', color: 'white', bold: true },
                            { text: 'Total', fillColor: '#e60000', color: 'white', bold: true },
                            { text: 'Part', fillColor: '#e60000', color: 'white', bold: true }
                        ],
                        ...sparepartData.map(item => {
                            let avail = '-';
                            if (item.availability) {
                                const val = item.availability.toLowerCase();
                                if (val === 'ada') avail = 'Ada';
                                else if (val === 'kosong') avail = 'Kosong';
                                else if (val === 'bo') avail = 'BO';
                                else if (val === 'tam') avail = 'TAM';
                            }
                            return [
                                truncateText(item.name, 25) || '-',
                                formatRupiah(item.price || 0),
                                item.qty || 1,
                                formatRupiah(item.total || item.subtotal || 0),
                                avail
                            ];
                        }),
                        [
                            { text: 'Total Harga Sparepart', colSpan: 3, alignment: 'right', bold: true }, {}, {},
                            { text: formatRupiah(totalHargaSparepart), bold: true },
                            ''
                        ]
                    ]
                },
                fontSize: 9,
                margin: [0, 0, 0, 12]
            });
        }

        // Tambahkan tabel service jika ada data
        if (serviceData.length > 0) {
            content.push({
                table: {
                    widths: ['*', 'auto', 'auto', 'auto'],
                    body: [
                        [
                            { text: 'Jenis Service', fillColor: '#2196F3', color: 'white', bold: true },
                            { text: 'Jam', fillColor: '#2196F3', color: 'white', bold: true },
                            { text: 'Harga/Jam', fillColor: '#2196F3', color: 'white', bold: true },
                            { text: 'Total', fillColor: '#2196F3', color: 'white', bold: true }
                        ],
                        ...serviceData.map(service => {
                            return [
                                truncateText(service.name || '-', 30),
                                service.hour || service.jam || 0,
                                formatRupiah(service.price || service.harga || 0),
                                formatRupiah(service.total || service.subtotal || 0)
                            ];
                        }),
                        [
                            { text: 'Total Harga Service', colSpan: 3, alignment: 'right', bold: true }, {}, {},
                            { text: formatRupiah(totalHargaService), bold: true }
                        ]
                    ]
                },
                fontSize: 9,
                margin: [0, 0, 0, 12]
            });
        }

        // Tambahkan total harga keseluruhan
        if (sparepartData.length > 0 || serviceData.length > 0) {
            content.push({
                table: {
                    widths: ['*', 'auto'],
                    body: [
                        [
                            { text: 'TOTAL HARGA KESELURUHAN', alignment: 'right', bold: true, fontSize: 11 },
                            { text: formatRupiah(totalHargaKeseluruhan), bold: true, fontSize: 11, color: '#e60000' }
                        ]
                    ]
                },
                margin: [0, 0, 0, 12]
            });
        }

       // Tambahkan gambar jika ada
if (fotoImages.length > 0) {
    content.push({
        text: 'Foto Estimasi:',
        fontSize: 10,
        bold: true,
        margin: [0, 10, 0, 5]
    });

    // Grid 3 kolom responsif dengan margin minimal
    const fotoPerBaris = 3;
    const rows = [];

    for (let i = 0; i < fotoImages.length; i += fotoPerBaris) {
        const rowImages = fotoImages.slice(i, i + fotoPerBaris);

        // masing-masing gambar proporsional
        const columns = rowImages.map(img => ({
            image: img,
            fit: [180, 145], // sedikit lebih besar agar memenuhi lebar halaman
            alignment: 'center',
            margin: [2, 0, 2, 0] // sedikit jarak antar gambar
        }));

        // jika jumlah gambar < 3, tambahkan kolom kosong agar tetap sejajar
        while (columns.length < fotoPerBaris) {
            columns.push({ text: '', width: '*' });
        }

        rows.push({
            columns: columns,
            columnGap: 6, // jarak antar kolom kecil saja
            margin: [0, 0, 0, 6]
        });
    }

    content.push(...rows);
    content.push({ text: '', margin: [0, 0, 0, 10] });
}

        // Tambahkan keterangan dan footer notes
        content.push(
            { text: '*Harga dapat berubah sewaktu-waktu tanpa pemberitahuan', fontSize: 8, italics: true, margin: [0, 0, 0, 2] },
            { text: '*Ada (Dapat dilakukan penggantian), TAM (Order 3 hari), BO (Order 1 bulan), Kosong (berhenti produksi)', fontSize: 8, italics: true, margin: [0, 0, 0, 12] },
            { text: `Keterangan: ${data.keterangan || 'Tidak ada keterangan tambahan'}`, fontSize: 10 }
        );

        const docDefinition = {
            pageSize: 'A5',
            pageMargins: [20, 80, 20, 80],

            header: {
                margin: [20, 20, 20, 10],
                stack: [
                    {
                        columns: [
                            {
                                width: 'auto',
                                image: tunasLogo,
                                fit: [25, 25],
                                margin: [0, 0, 8, 0]
                            },
                            {
                                width: '*',
                                stack: [
                                    { text: 'Tunas Toyota Batutulis', fontSize: 14, bold: true, color: '#e60000' },
                                    { text: 'Jl. Batutulis Raya No. 42, Jakarta Pusat', fontSize: 10 },
                                    { text: 'Telp: (021) 3454465', fontSize: 9 }
                                ],
                                alignment: 'left'
                            }
                        ]
                    },
                    {
                        margin: [0, 8, 0, 0],
                        canvas: [
                            { type: 'line', x1: 0, y1: 0, x2: 400, y2: 0, lineWidth: 1, color: '#e60000' }
                        ]
                    }
                ]
            },

            footer: function (currentPage, pageCount) {
                return {
                    margin: [20, 10, 20, 10],
                    stack: [
                        {
                            columns: [
                                {
                                    width: '*',
                                    stack: [
                                        { text: 'Hubungi kami untuk melakukan perbaikan:', bold: true, fontSize: 10 },
                                        { text: 'Admin Tunas Toyota', fontSize: 10 },
                                        {
                                            margin: [0, 2, 0, 0],
                                            columns: [
                                                {
                                                    width: 12,
                                                    image: whatsappIcon,
                                                    fit: [10, 10],
                                                    margin: [0, 0, 6, 0]
                                                },
                                                {
                                                    width: '*',
                                                    text: '081315389866',
                                                    fontSize: 10,
                                                    color: '#25D366',
                                                    link: 'https://wa.me/6281315389866'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    width: 60,
                                    image: qrBase64,
                                    fit: [50, 50]
                                }
                            ]
                        },
                        {
                            margin: [0, 5, 0, 0],
                            columns: [
                                {
                                    width: '*',
                                    text: `Dicetak pada: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}`,
                                    fontSize: 8,
                                    color: '#6c757d',
                                    alignment: 'left'
                                },
                                {
                                    width: 50,
                                    text: currentPage.toString() + ' / ' + pageCount,
                                    fontSize: 8,
                                    alignment: 'right'
                                }
                            ]
                        }
                    ]
                };
            },

            content: content
        };

        // 👉 Download PDF
        pdfMake.createPdf(docDefinition).download(`estimasi_${data.nopol}_${new Date().getTime()}.pdf`);

    } catch (error) {
        console.error('Error generating PDF:', error);
        //alert('Terjadi kesalahan saat membuat PDF: ' + error.message);
    }
}
// Fungsi helper untuk memotong teks
function truncateText(text, maxLength) {
    if (!text) return '';
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

// Fungsi format Rupiah
function formatRupiah(angka) {
    if (!angka) return 'Rp 0';
    return 'Rp ' + parseInt(angka).toLocaleString('id-ID');
}

// Fungsi getBase64FromUrl (pastikan sudah ada)
async function getBase64FromUrl(url) {
    const response = await fetch(url);
    const blob = await response.blob();
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = function() {
            resolve(reader.result);
        };
    });
}


        // Fungsi format Rupiah (jika belum ada)
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }
        
// Upload foto ke Supabase Storage - VERSI DIPERBAIKI
async function uploadFoto(file) {
    try {
        console.log("🚀 Memulai upload file:", file.name, "Size:", file.size, "Type:", file.type);

        // Validasi file
        if (!file || file.size === 0) {
            console.error("❌ File tidak valid atau kosong");
            return null;
        }

        // Generate nama file unik
        const fileExt = file.name.split('.').pop();
        const fileName = `${currentUser.id}/${Date.now()}_${Math.random().toString(36).substring(2)}.${fileExt}`;
        
        console.log("📁 Nama file di storage:", fileName);

        // Upload file ke Supabase Storage
        const { data, error } = await supabase.storage
            .from('estimasi-fotos')
            .upload(fileName, file, {
                cacheControl: '3600',
                upsert: false
            });

        if (error) {
            console.error("❌ Error upload ke storage:", error);
            
            // Handle specific errors
            if (error.message.includes('quota') || error.message.includes('storage')) {
                console.log("💾 Storage penuh, mencoba hapus file lama...");
                const newUrl = await handleStorageFull(file);
                return newUrl;
            } else if (error.message.includes('exists')) {
                console.log("📁 File sudah ada, generate nama baru...");
                // Coba dengan nama yang berbeda
                const newFileName = `${currentUser.id}/${Date.now()}_${Math.random().toString(36).substring(2)}_new.${fileExt}`;
                const { data: retryData, error: retryError } = await supabase.storage
                    .from('estimasi-fotos')
                    .upload(newFileName, file);
                
                if (retryError) throw retryError;
                data = retryData;
            } else {
                throw error;
            }
        }

        console.log("✅ Upload berhasil, data:", data);

        // Dapatkan URL publik
        const { data: { publicUrl } } = supabase.storage
            .from('estimasi-fotos')
            .getPublicUrl(fileName);

        console.log("🔗 URL publik:", publicUrl);
        return publicUrl;

    } catch (error) {
        console.error('❌ Error uploading foto:', error);
        
        // Tampilkan error spesifik ke user
        if (error.message.includes('quota')) {
            showToast('error', 'Storage Penuh', 'Storage gambar penuh. Silahkan hubungi administrator.');
        } else if (error.message.includes('JWT')) {
            showToast('error', 'Auth Error', 'Sesi login bermasalah. Silahkan login ulang.');
        } else {
            showToast('error', 'Upload Gagal', 'Gagal mengupload gambar: ' + error.message);
        }
        
        return null;
    }
}

        // Fungsi untuk debug storage - TAMBAHKAN INI
async function debugStorage() {
    try {
        console.log("🔍 Debug Storage Info:");
        
        // Cek bucket exists
        const { data: buckets, error: bucketsError } = await supabase.storage.listBuckets();
        if (bucketsError) {
            console.error("❌ Error list buckets:", bucketsError);
        } else {
            console.log("📦 Buckets tersedia:", buckets);
        }

        // Cek files user
        const { data: files, error: filesError } = await supabase.storage
            .from('estimasi-fotos')
            .list(`${currentUser.id}`, {
                limit: 10,
                offset: 0
            });

        if (filesError) {
            console.error("❌ Error list files:", filesError);
        } else {
            console.log(`📁 Files user ${currentUser.id}:`, files);
            console.log(`📊 Total files: ${files ? files.length : 0}`);
        }

        // Test upload kecil
        const testBlob = new Blob(['test'], { type: 'text/plain' });
        const testFile = new File([testBlob], 'test.txt');
        
        const { data: testUpload, error: testError } = await supabase.storage
            .from('estimasi-fotos')
            .upload(`${currentUser.id}/test_${Date.now()}.txt`, testFile);

        if (testError) {
            console.error("❌ Test upload gagal:", testError);
        } else {
            console.log("✅ Test upload berhasil:", testUpload);
            
            // Hapus file test
            await supabase.storage
                .from('estimasi-fotos')
                .remove([`${currentUser.id}/test_${Date.now()}.txt`]);
        }

    } catch (error) {
        console.error("❌ Debug storage error:", error);
    }
}

// Panggil fungsi debug (opsional, bisa di console)
// debugStorage();

// Handle storage penuh - VERSI DISEDERHANAKAN
async function handleStorageFull(newFile) {
    try {
        console.log("🔄 Menangani storage penuh...");
        
        // Dapatkan daftar file user
        const { data: files, error } = await supabase.storage
            .from('estimasi-fotos')
            .list(`${currentUser.id}`, {
                sortBy: { column: 'created_at', order: 'asc' }
            });

        if (error) throw error;

        if (files && files.length > 0) {
            // Hapus 5 file paling lama
            const filesToDelete = files.slice(0, Math.min(5, files.length));
            const filePaths = filesToDelete.map(file => `${currentUser.id}/${file.name}`);
            
            console.log("🗑️ Menghapus file lama:", filePaths);

            const { error: deleteError } = await supabase.storage
                .from('estimasi-fotos')
                .remove(filePaths);

            if (deleteError) throw deleteError;

            console.log("✅ File lama dihapus, mencoba upload ulang...");
            
            // Tunggu sebentar sebelum upload ulang
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Coba upload lagi
            return await uploadFoto(newFile);
        }

        console.error("❌ Tidak ada file yang bisa dihapus");
        return null;

    } catch (error) {
        console.error('❌ Error handling storage full:', error);
        return null;
    }
}

        // Format angka ke format Rupiah
        function formatRupiah(angka) {
            return 'Rp ' + new Intl.NumberFormat('id-ID').format(angka);
        }

        function showToast(type, title, message) {
            const toastEl = document.getElementById('liveToast');
            const toast = new bootstrap.Toast(toastEl);

            // reset class
            toastEl.classList.remove('text-bg-success', 'text-bg-danger', 'text-bg-warning');

            // warna sesuai type
            if (type === 'success') {
                toastEl.classList.add('text-bg-success');
            } else if (type === 'error') {
                toastEl.classList.add('text-bg-danger');
            } else if (type === 'warning') {
                toastEl.classList.add('text-bg-warning');
            }

            // isi toast
            toastEl.querySelector('.toast-body').innerHTML = `<strong>${title}</strong><br>${message}`;

            // tampilkan toast
            toast.show();
        }

// PERBAIKAN: Sidebar navigation - HAPUS DUPLIKAT DAN GUNAKAN INI SAJA
$(document).ready(function () {
    // Inisialisasi pertama
    initializeNavigation();

    // Mobile menu toggle
    $('#mobileMenuBtn').click(function () {
        $('#sidebar').toggleClass('show');
    });

    // Logout handler
    $('#logoutBtn, #logoutBtnDesktop').click(async function () {
        try {
            const { error } = await supabase.auth.signOut();
            if (error) throw error;
            window.location.href = 'login.html';
        } catch (error) {
            console.error('Error signing out:', error);
        }
    });

    // Tutup sidebar jika klik di luar saat di mobile
    $(document).on('click', function (e) {
        if ($(window).width() < 768) {
            if ($('#sidebar').hasClass('show') && 
                !$(e.target).closest('#sidebar, #mobileMenuBtn').length) {
                $('#sidebar').removeClass('show');
            }
        }
    });
});

// FUNGSI TERPISAH UNTUK NAVIGASI
function initializeNavigation() {
    // Hapus semua event listener sebelumnya untuk menghindari duplikasi
    $('.sidebar-menu a').off('click');
    
    // Tambahkan event listener baru
    $('.sidebar-menu a').click(function (e) {
        e.preventDefault();
        
        // Dapatkan section target
        const sectionId = $(this).data('section');
        
        // Validasi section yang boleh diakses
        const allowedSections = ['dashboard', 'input-estimasi', 'estimasi-saya', 'profil'];
        if (!allowedSections.includes(sectionId)) {
            console.warn('Section tidak diizinkan:', sectionId);
            return;
        }
        
        console.log('Navigating to:', sectionId); // Debug
        
        // Update active menu item
        $('.sidebar-menu a').removeClass('active');
        $(this).addClass('active');
        
        // Show corresponding section
        $('.content-section').removeClass('active');
        $(`#${sectionId}`).addClass('active');
        
        // Update page title
        const sectionTitle = $(this).find('span').text();
        $('#pageTitle').text(sectionTitle);
        $('#mobileTitle').text(sectionTitle);
        
        // Hide sidebar on mobile after selection
        if ($(window).width() < 768) {
            $('#sidebar').removeClass('show');
        }
        
        // Load data sesuai section
        loadSectionData(sectionId);
        
        // Scroll ke atas
        window.scrollTo(0, 0);
    });
}

// Fungsi untuk load data berdasarkan section
function loadSectionData(sectionId) {
    switch(sectionId) {
        case 'dashboard':
            loadDashboardData();
            break;
        case 'estimasi-saya':
            loadAllEstimasi();
            break;
        case 'profil':
            // Data profil sudah di-load di checkAuthState
            break;
        // 'input-estimasi' tidak perlu load data tambahan
    }
}

// PASTIKAN: Panggil initializeNavigation setelah DOM ready
$(document).ready(function() {
    initializeNavigation();
});

        function renderSpareparts(spareparts) {
            const tbody = document.querySelector('#editSparepartTable tbody');
            tbody.innerHTML = '';

            // Dalam fungsi renderSpareparts, pastikan value select ter-set dengan benar
            spareparts.forEach((item) => {
                const availabilityValue = item.availability || '';
                const row = `
                    <tr>
                        <td><input type="text" name="name" class="form-control" value="${item.name || ''}"></td>
                        <td><input type="number" name="price" class="form-control" value="${item.price || 0}"></td>
                        <td><input type="number" name="qty" class="form-control" value="${item.qty || 1}" min="1"></td>
                        <td>
                            <select name="availability" class="form-select">
                                <option value="" ${availabilityValue === '' ? 'selected' : ''}>Pilih</option>
                                <option value="ready" ${availabilityValue === 'ready' ? 'selected' : ''}>Ada</option>
                                <option value="tam" ${availabilityValue === 'tam' ? 'selected' : ''}>TAM</option>
                                <option value="bo" ${availabilityValue === 'bo' ? 'selected' : ''}>BO</option>
                            </select>
                        </td>
                        <td><button type="button" class="btn btn-sm btn-danger remove-row">🗑️</button></td>
                    </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });

            // Event listener untuk perubahan input
            tbody.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('change', () => {
                    checkSparepartChanges(originalSpareparts);
                });
            });

            // Event hapus baris
            tbody.querySelectorAll('.remove-row').forEach(btn => {
                btn.addEventListener('click', function () {
                    this.closest('tr').remove();
                    checkSparepartChanges(originalSpareparts);
                });
            });

            checkSparepartChanges(originalSpareparts);
        }

        // Hapus baris
        document.querySelector('#editSparepartTable').addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-row')) {
                e.target.closest('tr').remove();
                checkSparepartChanges(originalSpareparts);
            }
        });

        // Cek apakah sparepart berubah
        function checkSparepartChanges(originalData) {
            const currentData = [];
            document.querySelectorAll('#editSparepartTable tbody tr').forEach(row => {
                const nameInput = row.querySelector('input[name="name"]');
                const priceInput = row.querySelector('input[name="price"]');
                const qtyInput = row.querySelector('input[name="qty"]');
                const availabilitySelect = row.querySelector('select[name="availability"]'); // Perbaikan di sini

                currentData.push({
                    name: nameInput ? nameInput.value : '',
                    price: priceInput ? parseFloat(priceInput.value) || 0 : 0,
                    qty: qtyInput ? parseInt(qtyInput.value) || 1 : 1,
                    availability: availabilitySelect ? availabilitySelect.value : '' // Perbaikan di sini
                });
            });

            const changed = JSON.stringify(currentData) !== JSON.stringify(originalData);
            document.getElementById('sendToSparepartBtn').disabled = !changed;

            if (changed) {
                document.getElementById('sendToSparepartBtn').classList.remove('btn-secondary');
                document.getElementById('sendToSparepartBtn').classList.add('btn-warning');
            } else {
                document.getElementById('sendToSparepartBtn').classList.remove('btn-warning');
                document.getElementById('sendToSparepartBtn').classList.add('btn-secondary');
            }
        }

        // Fungsi untuk handle pencarian
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');

            // Pencarian saat tombol diklik
            searchBtn.addEventListener('click', () => {
                loadAllEstimasi(searchInput.value.trim());
            });

            // Pencarian saat tekan Enter
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loadAllEstimasi(searchInput.value.trim());
                }
            });

            // Clear search saat input dikosongkan
            searchInput.addEventListener('input', (e) => {
                if (e.target.value === '') {
                    loadAllEstimasi('');
                }
            });
        }
</script>
<script>
        document.getElementById("enableManualEdit").addEventListener("click", () => {
            const jenisMobilSelect = document.getElementById("jenisMobil");
            const telepon = document.getElementById("telepon");
            const nopol = document.getElementById("nopol");
            const nomorRangka = document.getElementById("nomorRangka");

            // Aktifkan semua field manual
            [jenisMobilSelect, telepon, nopol, nomorRangka].forEach(el => {
                el.removeAttribute("readonly");
                el.removeAttribute("disabled");
            });

            // Beri efek visual
            jenisMobilSelect.classList.add("border-primary");
            const btn = document.getElementById("enableManualEdit");
            btn.classList.replace("btn-outline-primary", "btn-success");
            btn.innerHTML = '<i class="fas fa-check"></i> Mode Manual Aktif';
        });

        document.getElementById("estimasiForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const nopol = document.getElementById("nopol").value.trim();
            const jenisMobil = document.getElementById("jenisMobil").value.trim();
            const sa = document.getElementById("serviceAdvisor").value.trim();
            const komponen = document.querySelector("[name='tags']").value.trim();

            if (!nopol || !jenisMobil || !sa || !komponen) {
                const toastEl = document.createElement("div");
                toastEl.className = "toast align-items-center text-white bg-danger border-0 position-fixed top-0 end-0 m-3";
                toastEl.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">⚠️ Harap isi semua field wajib yang bertanda * sebelum menyimpan!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;
                document.body.appendChild(toastEl);
                const toast = new bootstrap.Toast(toastEl);
                toast.show();
                setTimeout(() => toastEl.remove(), 4000);
                return;
            }

            this.submit();
        });
        // ✅ Ambil waktu server Supabase
        async function getServerTime() {
            try {
                const { data, error } = await supabase.rpc('get_server_time');
                if (error) throw error;
                return new Date(data);
            } catch (err) {
                console.error('Gagal ambil waktu server:', err);
                return new Date(); // fallback, meski tidak ideal
            }
        }

        // ✅ Cek apakah estimasi masih bisa diedit (kurang dari 24 jam)
        function canEdit(createdAt, serverTime) {
            const diffHours = (serverTime - new Date(createdAt)) / (1000 * 60 * 60);
            return diffHours < 24; // true jika masih < 24 jam
        }
</script>
<script>
        // Variabel untuk carousel
        let currentSlide = 0;
        const totalSlides = 2;
        let startX = 0;
        let endX = 0;
        let swipeHintTimeout = null;

        // Inisialisasi carousel
        function initCarousel() {
            const carousel = document.querySelector('.dashboard-carousel');

            // Mulai timer untuk menyembunyikan petunjuk geser
            startSwipeHintTimer();

            // Event listener untuk touch
            carousel.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                resetSwipeHintTimer(); // Reset timer saat user berinteraksi
            });

            carousel.addEventListener('touchmove', (e) => {
                endX = e.touches[0].clientX;
            });

            carousel.addEventListener('touchend', () => {
                handleSwipe();
                resetSwipeHintTimer(); // Reset timer setelah swipe
            });

            // Event listener untuk mouse (untuk desktop)
            carousel.addEventListener('mousedown', (e) => {
                startX = e.clientX;
                resetSwipeHintTimer(); // Reset timer saat user berinteraksi
                carousel.addEventListener('mousemove', handleMouseMove);
                carousel.addEventListener('mouseup', handleMouseUp);
                carousel.addEventListener('mouseleave', handleMouseUp);
            });

            // Event listener untuk indikator
            document.querySelectorAll('.carousel-indicator').forEach((indicator, index) => {
                indicator.addEventListener('click', () => {
                    resetSwipeHintTimer(); // Reset timer saat user klik indikator
                    goToSlide(index);
                });
            });

            // Event listener untuk hover (opsional - untuk testing)
            carousel.addEventListener('mouseenter', () => {
                resetSwipeHintTimer(); // Reset timer saat mouse masuk
            });
        }

        // Timer untuk menyembunyikan petunjuk geser
        function startSwipeHintTimer() {
            swipeHintTimeout = setTimeout(() => {
                hideSwipeHint();
            }, 3000); // 3 detik
        }

        // Reset timer petunjuk geser
        function resetSwipeHintTimer() {
            if (swipeHintTimeout) {
                clearTimeout(swipeHintTimeout);
            }

            // Tampilkan petunjuk jika sebelumnya disembunyikan
            showSwipeHint();

            // Mulai timer baru
            startSwipeHintTimer();
        }

        // Sembunyikan petunjuk geser
        function hideSwipeHint() {
            const swipeHint = document.getElementById('swipeHint');
            if (swipeHint) {
                swipeHint.classList.add('hidden');
            }
        }

        // Tampilkan petunjuk geser
        function showSwipeHint() {
            const swipeHint = document.getElementById('swipeHint');
            if (swipeHint) {
                swipeHint.classList.remove('hidden');
            }
        }

        // Handle mouse move
        function handleMouseMove(e) {
            endX = e.clientX;
        }

        // Handle mouse up
        function handleMouseUp() {
            const carousel = document.querySelector('.dashboard-carousel');
            carousel.removeEventListener('mousemove', handleMouseMove);
            carousel.removeEventListener('mouseup', handleMouseUp);
            carousel.removeEventListener('mouseleave', handleMouseUp);
            handleSwipe();
            resetSwipeHintTimer(); // Reset timer setelah swipe
        }

        // Handle swipe gesture
        function handleSwipe() {
            const swipeThreshold = 50;
            const diffX = startX - endX;

            if (Math.abs(diffX) > swipeThreshold) {
                if (diffX > 0) {
                    // Swipe kiri
                    nextSlide();
                } else {
                    // Swipe kanan
                    prevSlide();
                }
            }
        }

        // Pindah ke slide berikutnya
        function nextSlide() {
            if (currentSlide < totalSlides - 1) {
                currentSlide++;
                goToSlide(currentSlide);
            }
        }

        // Pindah ke slide sebelumnya
        function prevSlide() {
            if (currentSlide > 0) {
                currentSlide--;
                goToSlide(currentSlide);
            }
        }

        // Pergi ke slide tertentu
        function goToSlide(slideIndex) {
            // Update slides
            document.querySelectorAll('.dashboard-slide').forEach((slide, index) => {
                if (index === slideIndex) {
                    slide.classList.add('active');
                } else {
                    slide.classList.remove('active');
                }
            });

            // Update indicators
            document.querySelectorAll('.carousel-indicator').forEach((indicator, index) => {
                if (index === slideIndex) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });

            currentSlide = slideIndex;

            // Jika pindah ke slide grafik, load grafik
            if (slideIndex === 1) {
                loadKomponenChart();
            }
        }

        // Load data untuk grafik komponen
        async function loadKomponenChart() {
            try {
                if (!currentUser) return;

                const chartContainer = document.getElementById('komponenChart');
                chartContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Memuat grafik...</div>';

                // Dapatkan tanggal awal dan akhir bulan ini
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

                // Ambil data estimasi bulan ini
                const { data, error } = await supabase
                    .from('estimasi')
                    .select('id, created_at, komponen')
                    .eq('teknisi_id', currentUser.id)
                    .gte('created_at', firstDay.toISOString())
                    .lte('created_at', lastDay.toISOString())
                    .order('created_at', { ascending: true });

                if (error) throw error;

                // Proses data untuk grafik
                const weeklyData = processWeeklyKomponenData(data);

                // Render grafik
                renderKomponenChart(weeklyData);

            } catch (error) {
                console.error('Error loading chart data:', error);
                const chartContainer = document.getElementById('komponenChart');
                chartContainer.innerHTML = '<div class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Gagal memuat grafik</div>';
            }
        }

        // Proses data untuk grafik mingguan
        function processWeeklyKomponenData(estimasiData) {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

            // Hitung jumlah minggu dalam bulan (maksimal 5)
            const totalDays = lastDay.getDate();
            const weekCount = Math.ceil(totalDays / 7); // contoh: 31 hari → 5 minggu

            // Siapkan array data minggu
            const weeklyData = Array.from({ length: weekCount }, (_, i) => ({
                week: i + 1,
                komponenCount: 0
            }));

            // Hitung jumlah komponen per minggu (berdasarkan tanggal hari dalam bulan)
            estimasiData.forEach(estimasi => {
                const estimasiDate = new Date(estimasi.created_at);
                const day = estimasiDate.getDate();
                const weekIndex = Math.floor((day - 1) / 7); // 1–7 → minggu 0, 8–14 → minggu 1, dst.

                const komponenCount = Array.isArray(estimasi.komponen)
                    ? estimasi.komponen.length
                    : (estimasi.komponen ? 1 : 0);

                if (weekIndex >= 0 && weekIndex < weekCount) {
                    weeklyData[weekIndex].komponenCount += komponenCount;
                }
            });

            return weeklyData;
        }


        // Dapatkan nomor minggu dalam tahun
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        // Render grafik menggunakan Chart.js
        function renderKomponenChart(weeklyData) {
            const chartContainer = document.getElementById('komponenChart');

            // Kosongkan container
            chartContainer.innerHTML = '';

            // Buat canvas untuk grafik
            const canvas = document.createElement('canvas');
            canvas.id = 'komponenChartCanvas';
            chartContainer.appendChild(canvas);

            // Data untuk grafik
            const labels = weeklyData.map(week => `Minggu ${week.week}`);
            const data = weeklyData.map(week => week.komponenCount);

            // Buat grafik
            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jumlah Komponen',
                        data: data,
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah Komponen'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Minggu'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `Komponen: ${context.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Panggil fungsi inisialisasi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function () {
            initCarousel();
        });
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const editModal = document.getElementById('editEstimasiModal');

  // Ketika modal ditutup
  editModal.addEventListener('hidden.bs.modal', function () {
    // Hapus class blur di body atau elemen utama jika ada
    document.body.classList.remove('modal-open');
    document.body.style.overflow = 'auto';

    // Hapus backdrop bootstrap secara manual jika belum hilang
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(bd => bd.remove());
  });
});

// Konfigurasi Cloudinary
const cloudName = 'dawkeel4k';
const uploadPreset = 'ml_default';
let editSelectedImages = []; // Untuk menyimpan file baru
let existingImages = []; // Untuk menyimpan URL gambar yang sudah ada

// Inisialisasi image upload untuk modal edit
function initEditImageUpload() {
    const addImageBtn = document.getElementById('editAddImageBtn');
    const fileInput = document.getElementById('editFotoEstimasi');
    const imageContainer = document.getElementById('editImageUploadContainer');

    // 🧹 Hapus event listener lama dulu
    const newAddImageBtn = addImageBtn.cloneNode(true);
    addImageBtn.parentNode.replaceChild(newAddImageBtn, addImageBtn);

    // 🧩 Solusi penting: hapus event 'change' lama pada fileInput
    const newFileInput = fileInput.cloneNode(true);
    fileInput.parentNode.replaceChild(newFileInput, fileInput);

    // Tombol + hanya memicu klik pada input baru
    newAddImageBtn.addEventListener('click', () => {
        newFileInput.click();
    });

    // Event saat memilih file
    newFileInput.addEventListener('change', async (e) => {
        const files = e.target.files;
        if (!files || files.length === 0) return;

        if (editSelectedImages.length + files.length > 15) {
            showToast('error', 'Error', 'Maksimal 15 gambar yang dapat diupload!');
            return;
        }

        for (let i = 0; i < files.length; i++) {
            const file = files[i];

            if (!file.type.startsWith('image/')) {
                showToast('error', 'Error', 'Hanya file gambar yang diizinkan!');
                continue;
            }

            if (file.size > 5 * 1024 * 1024) {
                showToast('error', 'Error', `File ${file.name} terlalu besar. Maksimal 5MB!`);
                continue;
            }

            // Kompres gambar
            const compressedFile = await compressImage(file);
            editSelectedImages.push(compressedFile);

            // Preview
            const reader = new FileReader();
            reader.onload = (e) => {
                createImagePreview(e.target.result, true);
            };
            reader.readAsDataURL(compressedFile);
        }

        updateImageCounter();
        newFileInput.value = '';
    });
}


// Fungsi untuk membuat preview gambar
function createImagePreview(src, isNew = false) {
    const previewContainer = document.getElementById('editImagePreviewContainer');
    
    const imagePreviewContainer = document.createElement('div');
    imagePreviewContainer.className = 'image-preview-container';

    const imagePreview = document.createElement('img');
    imagePreview.src = src;
    imagePreview.className = 'edit-image-preview';

    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-image-btn';
    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
    removeBtn.onclick = () => {
        if (isNew) {
            // Hapus dari array editSelectedImages
            const index = editSelectedImages.findIndex(img => 
                typeof img === 'object' && img.name === imagePreview.dataset.filename
            );
            if (index !== -1) {
                editSelectedImages.splice(index, 1);
            }
        } else {
            // Hapus dari array existingImages
            const index = existingImages.indexOf(src);
            if (index !== -1) {
                existingImages.splice(index, 1);
            }
        }
        imagePreviewContainer.remove();
        updateImageCounter();
    };

    // Simpan nama file untuk referensi
    if (isNew && typeof src !== 'string') {
        imagePreview.dataset.filename = src.name;
    }

    imagePreviewContainer.appendChild(imagePreview);
    imagePreviewContainer.appendChild(removeBtn);
    previewContainer.appendChild(imagePreviewContainer);
}

// Fungsi untuk update counter gambar
function updateImageCounter() {
    const totalImages = existingImages.length + editSelectedImages.length;
    document.getElementById('editFotoCount').textContent = `${totalImages}/15 Foto`;
}

// Fungsi untuk upload gambar ke Cloudinary
async function uploadToCloudinary(file) {
    return new Promise((resolve, reject) => {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', uploadPreset);
        formData.append('cloud_name', cloudName);

        fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.secure_url) {
                resolve(data.secure_url);
            } else {
                reject(new Error('Upload gagal: ' + JSON.stringify(data)));
            }
        })
        .catch(error => {
            reject(error);
        });
    });
}

// Fungsi untuk memuat gambar yang sudah ada
function loadExistingImages(imageUrls) {
    const previewContainer = document.getElementById('editImagePreviewContainer');
    previewContainer.innerHTML = '';
    existingImages = [];

    if (imageUrls && imageUrls.length > 0) {
        imageUrls.forEach(url => {
            if (url) {
                existingImages.push(url);
                createImagePreview(url, false);
            }
        });
    }
    updateImageCounter();
}

// Modifikasi fungsi openEditEstimasi untuk menangani gambar
async function openEditEstimasi(id) {
    try {
        const { data, error } = await supabase
            .from('estimasi')
            .select('*')
            .eq('id', id)
            .single();

        if (error) throw error;

        // Isi form dengan data estimasi
        document.getElementById('editEstimasiId').value = data.id;
        document.getElementById('editNopol').value = data.nopol;
        document.getElementById('editJenisMobil').value = data.jenis_mobil;
        document.getElementById('editTelepon').value = data.telepon_customer;
        document.getElementById('editServiceAdvisor').value = data.service_advisor;
        document.getElementById('editNomorRangka').value = data.nomor_rangka || '';
        document.getElementById('editKeterangan').value = data.keterangan || '';

        // Simpan data sparepart asli
        originalSpareparts = Array.isArray(data.sparepart_data)
            ? data.sparepart_data
            : (data.sparepart_data ? JSON.parse(data.sparepart_data) : []);

        // Handle komponen di Tagify
        if (editTagify) {
            editTagify.removeAllTags();
            const komponenArray = Array.isArray(data.komponen) ? data.komponen :
                (data.komponen ? [data.komponen] : []);
            
            if (komponenArray.length > 0) {
                editTagify.addTags(komponenArray);
            }

            setTimeout(() => {
                syncSparepartDataWithKomponen(komponenArray, originalSpareparts);
                syncSparepartTable();
                debugSparepartSync('INITIAL LOAD');
            }, 300);
        }

        // Handle gambar yang sudah ada
        editSelectedImages = []; // Reset gambar baru
        let existingImageUrls = [];
        
        if (data.foto_url) {
            if (Array.isArray(data.foto_url)) {
                existingImageUrls = data.foto_url;
            } else if (typeof data.foto_url === 'string') {
                try {
                    existingImageUrls = JSON.parse(data.foto_url);
                    if (!Array.isArray(existingImageUrls)) {
                        existingImageUrls = [data.foto_url];
                    }
                } catch (e) {
                    existingImageUrls = [data.foto_url];
                }
            }
        }
        
        loadExistingImages(existingImageUrls);

        // Tampilkan modal
        const modal = new bootstrap.Modal(document.getElementById('editEstimasiModal'));
        modal.show();

    } catch (error) {
        console.error('Error loading estimasi for edit:', error);
        showToast('error', 'Error', 'Terjadi kesalahan saat memuat data estimasi: ' + error.message);
    }
}

// Modifikasi fungsi updateEstimasi untuk menangani upload gambar
async function updateEstimasi(statusAction = null) {
    try {
        const id = document.getElementById('editEstimasiId').value;
        const nopol = document.getElementById('editNopol').value.trim();
        const jenisMobil = document.getElementById('editJenisMobil').value;
        const telepon = document.getElementById('editTelepon').value.trim();
        const serviceAdvisor = document.getElementById('editServiceAdvisor').value;
        const nomorRangka = document.getElementById('editNomorRangka').value.trim();
        const keterangan = document.getElementById('editKeterangan').value.trim();

        // Ambil komponen dari Tagify
        const tags = (editTagify && Array.isArray(editTagify.value))
            ? editTagify.value.map(tag => tag.value)
            : [];

        if (!nopol || !jenisMobil || !telepon || !serviceAdvisor || tags.length === 0) {
            alert('Harap isi semua field yang diperlukan!');
            return;
        }

        console.log("=== DATA SEBELUM TRANSFORMASI ===");
        console.log("sparepartData:", sparepartData);

        // Upload gambar baru ke Cloudinary
        let newImageUrls = [];
        if (editSelectedImages.length > 0) {
            showToast('info', 'Upload', 'Mengupload gambar...');
            
            for (let i = 0; i < editSelectedImages.length; i++) {
                const image = editSelectedImages[i];
                try {
                    const imageUrl = await uploadToCloudinary(image);
                    newImageUrls.push(imageUrl);
                    console.log(`✅ Gambar ${i+1} berhasil diupload:`, imageUrl);
                } catch (error) {
                    console.error(`❌ Gagal upload gambar ${i+1}:`, error);
                    showToast('error', 'Upload Gagal', `Gagal mengupload gambar ${i+1}`);
                }
            }
        }

        // Gabungkan gambar lama dan baru
        const allImageUrls = [...existingImages, ...newImageUrls];
        console.log("📊 Semua URL gambar:", allImageUrls);

        // TRANSFORMASI data sparepart
        const sparepartsToSave = [];
        let totalHarga = 0;

        sparepartData.forEach((sparepartItem) => {
            if (!tags.includes(sparepartItem.name)) {
                console.warn(`Komponen ${sparepartItem.name} tidak ada dalam tags, dilewati`);
                return;
            }

            const itemTotal = (sparepartItem.price || 0) * (sparepartItem.qty || 1);
            totalHarga += itemTotal;

            const transformedItem = {
                name: sparepartItem.name,
                number: sparepartItem.number || '',
                price: sparepartItem.price || 0,
                availability: sparepartItem.availability || '',
                qty: sparepartItem.qty || 1,
                total: itemTotal
            };

            sparepartsToSave.push(transformedItem);
        });

        console.log("=== DATA SETELAH TRANSFORMASI ===");
        console.log("sparepartsToSave:", sparepartsToSave);

        // Validasi data sparepart
        const validationResults = validateSparepartData(sparepartsToSave);
        if (!validationResults.isValid) {
            console.error("VALIDASI GAGAL:", validationResults.errors);
            alert("Data sparepart tidak valid: " + validationResults.errors.join(", "));
            return;
        }

        // Payload untuk update
        const payload = {
            nopol,
            jenis_mobil: jenisMobil,
            telepon_customer: telepon,
            service_advisor: serviceAdvisor,
            nomor_rangka: nomorRangka,
            komponen: tags,
            keterangan,
            sparepart_data: sparepartsToSave,
            total_harga: totalHarga,
            updated_at: new Date().toISOString()
        };

        // Tambahkan foto_url hanya jika ada gambar
        if (allImageUrls.length > 0) {
            payload.foto_url = allImageUrls;
        }

        // Status opsional dari tombol
        if (statusAction) {
            payload.status = statusAction;
        }

        console.log("=== FINAL PAYLOAD KE DATABASE ===");
        console.log(JSON.stringify(payload, null, 2));

        const { error } = await supabase
            .from('estimasi')
            .update(payload)
            .eq('id', id);

        if (error) throw error;

        // Tampilkan pesan sukses
        let message = 'Estimasi berhasil diperbarui!';
        if (newImageUrls.length > 0) {
            message += ` ${newImageUrls.length} gambar baru diupload.`;
        }
        if (statusAction === 'pending') {
            message = 'Estimasi berhasil dikirim ke bagian sparepart!';
        } else if (statusAction === 'sent') {
            message = 'Estimasi berhasil dikirim ke Service Advisor!';
        }

        showToast('success', 'Berhasil', message);

        // Tutup modal dan reload data
        const modal = bootstrap.Modal.getInstance(document.getElementById('editEstimasiModal'));
        if (modal) modal.hide();

        await loadDashboardData();

    } catch (error) {
        console.error('Error updating estimasi:', error);
        showToast('error', 'Error', 'Terjadi kesalahan saat memperbarui estimasi: ' + error.message);
    }
}

// Panggil inisialisasi saat document ready
document.addEventListener('DOMContentLoaded', function() {
    initEditImageUpload();
});

// Reset data gambar ketika modal edit ditutup
document.getElementById('editEstimasiModal').addEventListener('hidden.bs.modal', function () {
    editSelectedImages = [];
    existingImages = [];
    document.getElementById('editImagePreviewContainer').innerHTML = '';
    updateImageCounter();
});

// Event listener untuk tombol di modal edit
document.addEventListener('DOMContentLoaded', function() {
    // Tombol Simpan Perubahan
    document.getElementById('updateEstimasiBtn').addEventListener('click', function() {
        updateEstimasi(); // Tanpa status action untuk simpan biasa
    });

    // Tombol Kirim ke Sparepart
// Tombol Kirim ke Sparepart - DENGAN TRIGGER FIREBASE & CLEANUP
document.getElementById('sendToSparepartBtn').addEventListener('click', async function() {
    // Simpan reference ke tombol
    const button = this;
    const originalText = button.innerHTML;
    
    try {
        // Tampilkan loading state
        button.innerHTML = '⏳ Mengirim...';
        button.disabled = true;

        // Panggil fungsi updateEstimasi yang sudah ada
        await updateEstimasi('pending');
        
        // Setelah update berhasil, trigger Firebase notification
        await triggerFirebaseNotificationAfterUpdate();
        
    } catch (error) {
        console.error('Error in sendToSparepartBtn:', error);
        showToast('error', 'Error', 'Gagal mengirim ke sparepart: ' + error.message);
    } finally {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    }
});

// Fungsi untuk trigger Firebase notification setelah update berhasil
async function triggerFirebaseNotificationAfterUpdate() {
    try {
        // Ambil data dari form yang baru diupdate
        const id = document.getElementById('editEstimasiId').value;
        const nopol = document.getElementById('editNopol').value.trim();
        const jenisMobil = document.getElementById('editJenisMobil').value;
        const serviceAdvisor = document.getElementById('editServiceAdvisor').value;
        const nomorRangka = document.getElementById('editNomorRangka').value.trim();
        const keterangan = document.getElementById('editKeterangan').value.trim();

        // Ambil data sparepart dari form
        const sparepartRows = document.querySelectorAll('#editSparepartBody tr');
        const sparepartData = [];
        
        sparepartRows.forEach((row, index) => {
            const name = row.querySelector('.col-name').value.trim();
            const number = row.querySelector('.col-number').value.trim();
            const price = parseNumber(row.querySelector('.col-price').value);
            const availability = row.querySelector('.col-availability').value;
            const qty = parseInt(row.querySelector('.col-qty').value) || 1;
            const total = price * qty;

            if (name) {
                sparepartData.push({
                    name,
                    number,
                    price,
                    availability,
                    qty,
                    total
                });
            }
        });

        // Siapkan data untuk Firebase
        const firebaseData = {
            id: parseInt(id),
            nopol: nopol,
            jenis_mobil: jenisMobil,
            nomor_rangka: nomorRangka,
            keterangan: keterangan || '',
            service_advisor: serviceAdvisor || '',
            sparepart_data: JSON.stringify(sparepartData),
            status: 'pending',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            teknisi: { full_name: 'Teknisi' } // Default value, sesuaikan jika ada data teknisi
        };

        console.log('🎯 Mengirim notifikasi Firebase:', firebaseData);

        // 1. Hapus notifikasi lama dengan ID yang sama (jika ada)
        await deleteOldFirebaseNotification(id);
        
        // 2. Hapus notifikasi lama (lebih dari 1 hari)
        await cleanupOldFirebaseNotifications();
        
        // 3. Kirim notifikasi baru ke Firebase
        await sendToFirebaseRealtime(firebaseData);
        
        showToast('success', 'Berhasil', 'Notifikasi terkirim ke bagian sparepart! 🔔');
        
    } catch (error) {
        console.error('Error triggering Firebase notification:', error);
        showToast('error', 'Peringatan', 'Estimasi tersimpan tapi notifikasi gagal dikirim: ' + error.message);
    }
}

// Fungsi untuk menghapus notifikasi lama dengan ID yang sama
async function deleteOldFirebaseNotification(estimasiId) {
    if (!window.firebaseDatabase) {
        console.warn('Firebase Database tidak tersedia');
        return;
    }

    try {
        const notificationRef = window.firebaseDatabase.ref(`estimasi_notifications/${estimasiId}`);
        await notificationRef.remove();
        console.log(`✅ Notifikasi lama dengan ID ${estimasiId} dihapus`);
    } catch (error) {
        console.warn(`⚠️ Gagal menghapus notifikasi lama ID ${estimasiId}:`, error);
    }
}

// Fungsi untuk membersihkan notifikasi lama (lebih dari 1 hari)
async function cleanupOldFirebaseNotifications() {
    if (!window.firebaseDatabase) {
        console.warn('Firebase Database tidak tersedia');
        return;
    }

    try {
        const notificationsRef = window.firebaseDatabase.ref('estimasi_notifications');
        const snapshot = await notificationsRef.once('value');
        
        if (!snapshot.exists()) {
            console.log('📭 Tidak ada notifikasi untuk dibersihkan');
            return;
        }

        const now = new Date();
        const oneDayAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000)); // 1 hari yang lalu
        
        let deletedCount = 0;
        const updates = {};

        snapshot.forEach((childSnapshot) => {
            const notification = childSnapshot.val();
            const createdDate = new Date(notification.created_at);
            
            // Hapus jika notifikasi lebih dari 1 hari
            if (createdDate < oneDayAgo) {
                updates[childSnapshot.key] = null; // Mark for deletion
                deletedCount++;
            }
        });

        // Eksekusi penghapusan
        if (Object.keys(updates).length > 0) {
            await notificationsRef.update(updates);
            console.log(`🗑️ ${deletedCount} notifikasi lama dihapus`);
        } else {
            console.log('✅ Tidak ada notifikasi lama yang perlu dihapus');
        }
        
    } catch (error) {
        console.error('❌ Error cleaning up old notifications:', error);
    }
}

// Fungsi untuk mengirim data ke Firebase Realtime Database
async function sendToFirebaseRealtime(estimasiData) {
    // Gunakan window.firebaseDatabase untuk memastikan variabel terdefinisi
    if (!window.firebaseDatabase) {
        // Coba initialize Firebase jika belum ada
        if (!window.firebaseApp) {
            await initializeFirebase();
        }
        
        if (!window.firebaseDatabase) {
            throw new Error('Firebase Database tidak tersedia');
        }
    }

    try {
        const notificationsRef = window.firebaseDatabase.ref('estimasi_notifications');
        const estimasiRef = notificationsRef.child(estimasiData.id.toString());
        
        // Kirim data ke Firebase
        await estimasiRef.set(estimasiData);
        
        console.log('✅ Firebase notification berhasil dikirim:', estimasiData.id);
        return true;
        
    } catch (error) {
        console.error('❌ Error sending to Firebase:', error);
        throw error;
    }
}

// Fungsi untuk initialize Firebase (jika belum diinisialisasi)
async function initializeFirebase() {
    try {
        // Firebase Config (sama dengan yang di main script)
        const firebaseConfig = {
            apiKey: "AIzaSyAUEF9oqJGOS_14qYTI-Jz2xHCd2KpIlMs",
            authDomain: "tunas-evo.firebaseapp.com",
            databaseURL: "https://tunas-evo-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tunas-evo",
            storageBucket: "tunas-evo.firebasestorage.app",
            messagingSenderId: "389746033999",
            appId: "1:389746033999:web:de920c80778cfe41aff13a",
            measurementId: "G-8NT82P3FFM"
        };

        // Initialize Firebase
        window.firebaseApp = window.firebase.initializeApp(firebaseConfig);
        window.firebaseDatabase = window.firebase.database();
        
        console.log('✅ Firebase initialized successfully');
        return true;
        
    } catch (error) {
        console.error('❌ Firebase initialization failed:', error);
        return false;
    }
}

// Fungsi parseNumber
function parseNumber(txt) {
    if (!txt) return 0;
    let s = String(txt).trim();

    if (s.match(/^\d{1,3}(,\d{3})+(\.\d+)?$/)) {
        s = s.replace(/,/g, '');
        s = s.split('.')[0];
        return parseInt(s, 10) || 0;
    }

    if (s.match(/^\d{1,3}(\.\d{3})+(,\d+)?$/)) {
        s = s.replace(/\./g, '');
        s = s.split(',')[0];
        return parseInt(s, 10) || 0;
    }

    s = s.replace(/[^\d]/g, '');
    return parseInt(s, 10) || 0;
}

// Fungsi showToast
function showToast(type, title, message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#fff3cd'};
        color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#856404'};
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 300px;
        border-left: 4px solid ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#ffc107'};
    `;

    toast.innerHTML = `
        <strong>${title}</strong><br>
        ${message}
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}

    // Tombol Kirim ke SA
// Tombol Kirim ke SA - DENGAN TRIGGER FIREBASE
document.getElementById('sendToSABtn').addEventListener('click', async function() {
    try {
        // Ambil data SA dari form
        const serviceAdvisor = document.getElementById('editServiceAdvisor').value;
        const nopol = document.getElementById('editNopol').value.trim();
        
        if (!serviceAdvisor) {
            alert('Pilih Service Advisor terlebih dahulu!');
            return;
        }

        // 1. Update estimasi ke database
        await updateEstimasi('sent');
        
        // 2. Trigger Firebase notification ke SA tertentu
        if (window.triggerFirebaseNotification) {
            const success = window.triggerFirebaseNotification(serviceAdvisor, nopol);
            if (success) {
                console.log(`✅ Notifikasi Firebase dikirim ke: ${serviceAdvisor}`);
            } else {
                console.log('❌ Gagal mengirim notifikasi Firebase');
            }
        } else {
            console.log('❌ Fungsi triggerFirebaseNotification tidak tersedia');
        }

    } catch (error) {
        console.error('Error dalam proses kirim ke SA:', error);
    }
});

// FUNGSI TRIGGER FIREBASE - TAMBAHKAN DI DASHBOARD TEKNISI
window.triggerFirebaseNotification = function(serviceAdvisor, nopol = '') {
    try {
        // Pastikan Firebase sudah diinisialisasi
        if (typeof firebase === 'undefined' || !firebase.database) {
            console.error('Firebase tidak tersedia');
            return false;
        }

        // Inisialisasi Firebase (jika belum)
        if (!window.firebaseDb) {
            const firebaseConfig = {
                apiKey: "AIzaSyAUEF9oqJGOS_14qYTI-Jz2xHCd2KpIlMs",
                authDomain: "tunas-evo.firebaseapp.com",
                databaseURL: "https://tunas-evo-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "tunas-evo",
                storageBucket: "tunas-evo.firebasestorage.app",
                messagingSenderId: "389746033999",
                appId: "1:389746033999:web:de920c80778cfe41aff13a",
                measurementId: "G-8NT82P3FFM"
            };
            
            try {
                const firebaseApp = firebase.initializeApp(firebaseConfig);
                window.firebaseDb = firebase.database();
                console.log('✅ Firebase initialized di dashboard teknisi');
            } catch (error) {
                console.log('Firebase sudah diinisialisasi');
            }
        }

        // Trigger notification ke SA tertentu
        if (window.firebaseDb) {
            const notificationRef = window.firebaseDb.ref(`notifications/${serviceAdvisor}`);
            notificationRef.update({
                trigger: true,
                nopol: nopol,
                timestamp: new Date().toISOString(),
                message: `Estimasi baru: ${nopol}`,
                service_advisor: serviceAdvisor
            });
            
            console.log(`🎯 Firebase notification triggered untuk: ${serviceAdvisor}`);
            return true;
        }
        
        return false;
        
    } catch (error) {
        console.error('❌ Error triggering Firebase notification:', error);
        return false;
    }
};

    // Tombol Hapus
    document.getElementById('deleteEstimasiBtn').addEventListener('click', function() {
        const estimasiId = document.getElementById('editEstimasiId').value;
        if (estimasiId) {
            deleteEstimasi(estimasiId);
        }
    });

    // Inisialisasi upload gambar
    initEditImageUpload();
});
</script>
<!-- Tambahkan Chart.js library di head -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Toast container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055">
    <div
        id="liveToast"
        class="toast align-items-center text-bg-success border-0"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
    >
        <div class="d-flex">
            <div class="toast-body">
                ✅ Berhasil
            </div>
            <button
                type="button"
                class="btn-close btn-close-white me-2 m-auto"
                data-bs-dismiss="toast"
                aria-label="Close"
            ></button>
        </div>
    </div>
</div>
</body>
</html>
